---
phase: 03-animation-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/traits/migration.ts
  - src/__tests__/lib/traits-migration.test.ts
autonomous: true

must_haves:
  truths:
    - "Pet traits load from database JSON field on every render, never regenerated client-side for existing pets"
    - "Same pet displays identical appearance after page reload and across browser sessions"
    - "Trait data includes traitVersion field enabling future schema evolution"
    - "Pets with missing or malformed trait fields fall back gracefully to regenerated traits"
  artifacts:
    - path: "src/lib/traits/migration.ts"
      provides: "Trait loading, validation, and version migration utility"
      exports: ["loadTraits", "migrateTraits"]
  key_links:
    - from: "src/lib/traits/migration.ts"
      to: "src/lib/traits/validation.ts"
      via: "PetTraitsSchema.safeParse for runtime validation"
      pattern: "PetTraitsSchema\\.safeParse"
    - from: "src/lib/traits/migration.ts"
      to: "src/lib/traits/generation.ts"
      via: "generatePetTraits fallback for missing/invalid traits"
      pattern: "generatePetTraits"
---

<objective>
Create the trait persistence utility that ensures pets always load their visual identity from the database, handle version migration for future schema changes, and gracefully fall back when trait data is missing or malformed.

Purpose: Pets must maintain visual identity across sessions and devices (PERSIST-01, PERSIST-02). The trait system needs versioning for future evolution (PERSIST-03) and backward compatibility for older pets (PERSIST-04).

Output: `src/lib/traits/migration.ts` with tested `loadTraits` and `migrateTraits` functions, plus comprehensive test suite.
</objective>

<execution_context>
@/Users/tarikstafford/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tarikstafford/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-animation-persistence/03-RESEARCH.md

@src/lib/traits/types.ts
@src/lib/traits/validation.ts
@src/lib/traits/generation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trait migration and loading utility</name>
  <files>src/lib/traits/migration.ts</files>
  <action>
Create `src/lib/traits/migration.ts` that provides two exported functions:

**`loadTraits(rawTraits: unknown, petId: string): PetTraits`**
- Accepts raw JSON from database `traits` field and the pet ID
- If `rawTraits` is null/undefined, regenerate using `generatePetTraits(petId)` and log a warning (legacy pet without traits)
- If `rawTraits` is not an object, regenerate and log warning
- Delegates to `migrateTraits` for version-aware validation
- Returns validated `PetTraits` object (never throws)

**`migrateTraits(traits: Record<string, unknown>, petId: string): PetTraits`**
- Checks `traitVersion` field on input
- For version 1 (current): validate with `PetTraitsSchema.safeParse()`. If valid, return parsed data. If invalid, log warning with parse errors and regenerate via `generatePetTraits(petId)`
- For unknown/missing version: log warning and regenerate via `generatePetTraits(petId)`
- Include commented placeholder for future version 2 migration path (// Future: if traitVersion === 2, migrate v2 -> v1)
- Returns validated `PetTraits` (never throws)

Import `generatePetTraits` from `@/lib/traits/generation`, `PetTraitsSchema` from `@/lib/traits/validation`, and `PetTraits` type from `@/lib/traits/types`.

Use `console.warn` for all warning messages (consistent with existing PetSVG fallback pattern). Prefix warnings with `[traits]` for easy log filtering, e.g. `[traits] Missing traits for pet ${petId}, regenerating`.

Do NOT add a database update/save call inside these functions. They are pure data transformation utilities -- the caller is responsible for persisting regenerated traits if needed.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm TypeScript compilation passes with no errors.
Verify the file exports `loadTraits` and `migrateTraits` functions.
  </verify>
  <done>
`src/lib/traits/migration.ts` exists with two exported functions that handle null traits, valid v1 traits, invalid v1 traits, and unknown versions -- all returning valid PetTraits without throwing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive tests for trait migration</name>
  <files>src/__tests__/lib/traits-migration.test.ts</files>
  <action>
Create `src/__tests__/lib/traits-migration.test.ts` with test cases covering all persistence requirements:

**Test group: loadTraits**
1. "returns valid traits when database has valid v1 trait data" -- pass a complete valid PetTraits object, assert returned object matches input exactly
2. "regenerates traits when rawTraits is null" -- pass null, assert returns a valid PetTraits object (validate with PetTraitsSchema)
3. "regenerates traits when rawTraits is undefined" -- pass undefined, assert valid PetTraits returned
4. "regenerates traits when rawTraits is not an object (string)" -- pass "invalid", assert valid PetTraits returned
5. "regenerates traits when rawTraits is not an object (number)" -- pass 42, assert valid PetTraits returned
6. "produces identical traits for same petId on repeated calls" -- call loadTraits(null, samePetId) twice, assert deep equality (PERSIST-02: cross-session consistency)

**Test group: migrateTraits**
7. "validates and returns v1 traits" -- pass valid v1 traits object, assert returned object matches
8. "regenerates when v1 traits have invalid fields" -- pass object with traitVersion:1 but missing bodyColor, assert returns valid PetTraits (not the broken input)
9. "regenerates when v1 traits have wrong types" -- pass object with traitVersion:1 but bodyColor as string "red", assert returns valid PetTraits
10. "regenerates when traitVersion is missing" -- pass object without traitVersion field, assert returns valid PetTraits
11. "regenerates when traitVersion is unknown (999)" -- pass object with traitVersion:999, assert returns valid PetTraits
12. "handles partial trait data gracefully" -- pass object with traitVersion:1 and only bodyColor (missing other fields), assert returns valid PetTraits

**Test group: deterministic regeneration (PERSIST-02)**
13. "same petId always regenerates identical traits" -- for 3 different petIds, call loadTraits(null, id) twice each and assert deep equality
14. "different petIds produce different traits" -- call loadTraits(null, "pet-a") and loadTraits(null, "pet-b"), assert traits are not identical

Import `generatePetTraits` from `@/lib/traits/generation` to build valid test fixtures. Use `PetTraitsSchema` for validation assertions.

Follow existing test patterns: use `describe`/`it` blocks, import from `@/` aliases.
  </action>
  <verify>
Run `npx vitest run src/__tests__/lib/traits-migration.test.ts` and confirm all tests pass.
Run `npx vitest run` to confirm no regressions across the full test suite.
  </verify>
  <done>
All 14 trait migration tests pass. Full test suite shows zero regressions. PERSIST-01 through PERSIST-04 requirements are verified through test coverage.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vitest run src/__tests__/lib/traits-migration.test.ts` -- all tests pass
3. `npx vitest run` -- full suite passes with zero regressions
4. `loadTraits(null, "any-pet-id")` returns valid PetTraits (backward compat)
5. `loadTraits(validTraits, "any-pet-id")` returns the same traits unchanged (persistence)
6. Same petId always produces identical fallback traits (cross-session consistency)
</verification>

<success_criteria>
- Trait migration utility handles all edge cases without throwing exceptions
- All 14+ tests pass covering null, invalid, versioned, and partial trait data
- Zero regressions in existing test suite
- Function signatures are clear for downstream consumers (Phase 4 display rollout)
</success_criteria>

<output>
After completion, create `.planning/phases/03-animation-persistence/03-01-SUMMARY.md`
</output>
