---
phase: 03-animation-persistence
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/hooks/usePageVisibility.ts
  - src/hooks/useReducedMotion.ts
  - src/components/pet-svg/AnimatedPetSVG.tsx
  - src/components/pet-svg/pet-animations.css
  - src/components/pet-svg/index.ts
  - src/app/globals.css
autonomous: false

must_haves:
  truths:
    - "Pets display smooth idle breathing animation that scales subtly over a 3-4 second cycle"
    - "Pets blink randomly at natural intervals between 3 and 5 seconds with 200ms blink duration"
    - "Small pets breathe faster (2.5s), large pets breathe slower (4.5s), medium is default (3.5s)"
    - "Animations pause automatically when browser tab is inactive"
    - "Animations are disabled when user has prefers-reduced-motion enabled"
    - "All animations use only transform and opacity CSS properties (GPU-accelerated, no layout thrashing)"
    - "Each pet has a unique animation phase offset so multiple pets do not breathe or blink in sync"
    - "AnimatedPetSVG validates traits via loadTraits before rendering, ensuring persistence safety (PERSIST-01)"
  artifacts:
    - path: "src/hooks/usePageVisibility.ts"
      provides: "Hook returning boolean for tab active state"
      exports: ["usePageVisibility"]
    - path: "src/hooks/useReducedMotion.ts"
      provides: "Hook returning boolean for prefers-reduced-motion preference"
      exports: ["useReducedMotion"]
    - path: "src/components/pet-svg/AnimatedPetSVG.tsx"
      provides: "Animated wrapper around PetSVG with breathing, blinking, pause, accessibility"
      exports: ["AnimatedPetSVG"]
    - path: "src/components/pet-svg/pet-animations.css"
      provides: "CSS @keyframes for breathe and blink animations, GPU-accelerated"
      contains: "@keyframes pet-breathe"
    - path: "src/components/pet-svg/index.ts"
      provides: "Barrel export including AnimatedPetSVG"
      exports: ["PetSVG", "AnimatedPetSVG"]
  key_links:
    - from: "src/components/pet-svg/AnimatedPetSVG.tsx"
      to: "src/components/pet-svg/PetSVG.tsx"
      via: "Renders PetSVG as child with animation CSS classes"
      pattern: "<PetSVG"
    - from: "src/components/pet-svg/AnimatedPetSVG.tsx"
      to: "src/hooks/usePageVisibility.ts"
      via: "Controls animation pause on tab inactive"
      pattern: "usePageVisibility"
    - from: "src/components/pet-svg/AnimatedPetSVG.tsx"
      to: "src/hooks/useReducedMotion.ts"
      via: "Disables animations for accessibility"
      pattern: "useReducedMotion"
    - from: "src/components/pet-svg/AnimatedPetSVG.tsx"
      to: "seedrandom"
      via: "Generates unique animation delay per pet ID"
      pattern: "seedrandom"
    - from: "src/components/pet-svg/AnimatedPetSVG.tsx"
      to: "src/lib/traits/migration.ts"
      via: "Validates and migrates traits before rendering (PERSIST-01 wiring)"
      pattern: "loadTraits"
    - from: "src/components/pet-svg/pet-animations.css"
      to: "src/app/globals.css"
      via: "Imported in globals.css for application-wide availability"
      pattern: "pet-animations"
---

<objective>
Build the complete idle animation system: breathing, blinking, tab-pause, accessibility, body-size timing, and unique per-pet phase offsets. Wrap the existing PetSVG in an AnimatedPetSVG component that handles all animation state externally, keeping PetSVG pure and React.memo-friendly.

Purpose: Pets must feel alive through natural idle animations (ANIM-01 through ANIM-07). Animations must be performant (GPU-only), accessible (motion sensitivity), and battery-friendly (tab pause).

Output: Two React hooks, one CSS animation file, one AnimatedPetSVG wrapper component, updated barrel export.
</objective>

<execution_context>
@/Users/tarikstafford/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tarikstafford/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-animation-persistence/03-RESEARCH.md

# Prior plan SUMMARY needed: 03-01 creates loadTraits utility used by AnimatedPetSVG
@.planning/phases/03-animation-persistence/03-01-SUMMARY.md

@src/lib/traits/migration.ts
@src/components/pet-svg/PetSVG.tsx
@src/components/pet-svg/ExpressionLayer.tsx
@src/components/pet-svg/index.ts
@src/lib/traits/types.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create animation hooks and CSS keyframes</name>
  <files>
    src/hooks/usePageVisibility.ts
    src/hooks/useReducedMotion.ts
    src/components/pet-svg/pet-animations.css
    src/app/globals.css
  </files>
  <action>
**1. Create `src/hooks/usePageVisibility.ts`:**

Custom React hook that returns a boolean indicating whether the browser tab is active.

```typescript
export function usePageVisibility(): boolean
```

- Initialize state with `typeof document !== 'undefined' ? !document.hidden : true` (SSR-safe)
- Add `visibilitychange` event listener in useEffect
- Clean up listener on unmount
- Return `isVisible` boolean

**2. Create `src/hooks/useReducedMotion.ts`:**

Custom React hook that returns a boolean indicating whether the user prefers reduced motion.

```typescript
export function useReducedMotion(): boolean
```

- Initialize state with `typeof window !== 'undefined' ? window.matchMedia('(prefers-reduced-motion: reduce)').matches : false` (SSR-safe)
- Add `change` event listener on the MediaQueryList in useEffect
- Clean up listener on unmount
- Return `prefersReducedMotion` boolean

**3. Create `src/components/pet-svg/pet-animations.css`:**

CSS file containing all animation keyframes and utility classes. CRITICAL: Only animate `transform` and `opacity` properties (GPU-accelerated, ANIM-06).

Define the following:

```css
/* Breathing animation - subtle scale from center (ANIM-01) */
@keyframes pet-breathe {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

/* Blink animation - opacity flash on eyes (ANIM-02) */
@keyframes pet-blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}
```

Animation classes:
- `.pet-animate-breathing` - Applies breathe animation with `var(--pet-breathing-duration, 3.5s)` duration, `var(--pet-breathing-delay, 0s)` delay, `ease-in-out` timing, `infinite` iteration, `transform-origin: center center`
- `.pet-animate-breathing.pet-paused` - Sets `animation-play-state: paused`
- `.pet-blinking .pet-eyes` - Applies blink animation with 0.2s duration, single iteration (ANIM-02: 200ms blink)

Add a `@media (prefers-reduced-motion: reduce)` block that sets `animation: none !important` on `.pet-animate-breathing` and `.pet-blinking .pet-eyes` as a CSS-level fallback (ANIM-05). This provides defense-in-depth alongside the React hook.

**4. Update `src/app/globals.css`:**

Add an import at the TOP of the file (before any existing content):
```css
@import '../components/pet-svg/pet-animations.css';
```

This makes the animation classes available application-wide. If globals.css already uses `@tailwind` directives, place the import AFTER the tailwind imports but BEFORE any custom styles.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm TypeScript compilation passes.
Verify `src/hooks/usePageVisibility.ts` and `src/hooks/useReducedMotion.ts` exist and export their respective hooks.
Verify `src/components/pet-svg/pet-animations.css` contains `@keyframes pet-breathe` and `@keyframes pet-blink`.
Verify `src/app/globals.css` imports the pet-animations.css file.
  </verify>
  <done>
Two SSR-safe hooks exist and compile. CSS keyframes use only transform and opacity. Animation classes support CSS custom properties for duration and delay. Reduced motion media query disables animations at CSS level. globals.css imports the animation stylesheet.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AnimatedPetSVG wrapper component</name>
  <files>
    src/components/pet-svg/AnimatedPetSVG.tsx
    src/components/pet-svg/ExpressionLayer.tsx
    src/components/pet-svg/index.ts
  </files>
  <action>
**1. Create `src/components/pet-svg/AnimatedPetSVG.tsx`:**

A `'use client'` component that wraps PetSVG with all animation behavior. This keeps animation state OUTSIDE PetSVG so React.memo on PetSVG still works (avoids Pitfall 6 from research).

```typescript
interface AnimatedPetSVGProps {
  petId: string;
  traits: PetTraits;
  size?: 'small' | 'medium' | 'large';
  className?: string;
}
```

**NOTE:** PetSVG already accepts `className` and passes it to the root `<svg>` element (confirmed in PetSVG.tsx line 76). No changes needed to PetSVG for className pass-through.

Implementation:

a) **Trait validation (PERSIST-01 wiring):** Import `loadTraits` from `@/lib/traits/migration` (created in Plan 03-01). Call `const validatedTraits = useMemo(() => loadTraits(traits, petId), [traits, petId])` at the top of the component. This ensures every AnimatedPetSVG render passes through the persistence safety layer -- traits are validated, version-migrated, and gracefully fall back if malformed. Use `validatedTraits` (not raw `traits`) for ALL downstream logic (body size lookup, PetSVG rendering).

b) **Hooks:** Call `usePageVisibility()` and `useReducedMotion()`.

c) **Unique animation offset (ANIM-07):** Use `seedrandom(petId)` to generate a deterministic negative delay for breathing: `-(rng() * 3.5)` seconds. This starts each pet at a different point in its breathing cycle. Compute this with `useMemo` keyed on `petId` so it doesn't recalculate on every render.

d) **Body-size-specific timing (ANIM-03):** Map `validatedTraits.bodySize` to breathing duration: small = 2.5s, medium = 3.5s, large = 4.5s. Compute with `useMemo` keyed on `traits.bodySize`.

e) **Blink scheduling (ANIM-02):** Use `useEffect` to schedule random blinks:
   - Only run when `isVisible && !reducedMotion`
   - Use `seedrandom(`${petId}-blink-${Date.now()}`)` for randomized (not deterministic) intervals
   - Schedule next blink after 3000 + rng() * 2000 ms (3-5 second range)
   - On blink trigger: set `isBlinking` state to true, then after 200ms set back to false
   - Clean up all timeouts on unmount or when visibility/motion preference changes
   - IMPORTANT: Use a ref to track timeout IDs so cleanup works correctly. Use a recursive scheduling pattern (schedule next blink after current blink completes) rather than setInterval.

f) **Determine animation state:** Compute `shouldAnimate = isVisible && !reducedMotion`.

g) **Render:** Return a `<div>` wrapper that:
   - Sets CSS custom properties as inline styles: `--pet-breathing-duration` and `--pet-breathing-delay`
   - Passes `className` to the wrapper div
   - Renders `<PetSVG>` inside with:
     - `traits={validatedTraits}` (NOT raw `traits` -- use the loadTraits-validated version)
     - `size={size}`
     - `className` built with string concatenation (no external cn utility needed):
       - Always include `'pet-svg-animated'`
       - Add `'pet-animate-breathing'` when `shouldAnimate` is true
       - Add `'pet-paused'` when `!isVisible` (tab hidden but not reduced motion -- pause instead of remove)
       - Add `'pet-blinking'` when `isBlinking` is true

**NOTE on blinking approach:** Blink state is applied via CSS classes on the SVG element (`pet-blinking` class), NOT by passing an `isBlinking` prop through PetSVG. This keeps PetSVG's React.memo intact. The CSS selector `.pet-blinking .pet-eyes` targets eye elements in ExpressionLayer via a className on the eye group wrapper (see below).

**2. Update `src/components/pet-svg/ExpressionLayer.tsx`:**

Add a `className="pet-eyes"` attribute to the outer `<g>` element that wraps all eye elements. This is a minimal change -- just add the className prop to the existing `<g>` tag:

Change the outer `<g>` from:
```tsx
<g transform={`translate(50, 50) scale(${scale}) translate(-50, -50)`}>
```
to:
```tsx
<g className="pet-eyes" transform={`translate(50, 50) scale(${scale}) translate(-50, -50)`}>
```

This gives the CSS `.pet-blinking .pet-eyes` selector a target for the blink opacity animation. The mouth elements are inside the same group but the blink animation only targets opacity, which creates a natural "eyes closing" effect. If the mouth opacity changing looks odd, instead wrap ONLY the eye circles (not the mouth paths) in a nested `<g className="pet-eyes">`. Use your judgment -- if all expression elements are circles/ellipses for eyes plus path for mouth, wrap only the eye circles.

Actually, the cleanest approach: for each expression type, wrap ONLY the eye elements (circles/ellipses, NOT the mouth path/line) in a `<g className="pet-eyes">`. This ensures only eyes blink, not the mouth. Each expression block already has clearly labeled eye and mouth sections.

**3. Update `src/components/pet-svg/index.ts`:**

Add export for AnimatedPetSVG:
```typescript
export { AnimatedPetSVG } from './AnimatedPetSVG';
export type { AnimatedPetSVGProps } from './AnimatedPetSVG';
```

Keep the existing PetSVG and PetSVGProps exports.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm TypeScript compilation passes with no errors.
Run `npx vitest run` to confirm no regressions in existing PetSVG tests.
Verify `src/components/pet-svg/AnimatedPetSVG.tsx` imports usePageVisibility, useReducedMotion, seedrandom, PetSVG, and loadTraits.
Verify PERSIST-01 wiring: `grep 'loadTraits' src/components/pet-svg/AnimatedPetSVG.tsx` returns match.
Verify PetSVG className pass-through: `grep 'className={className}' src/components/pet-svg/PetSVG.tsx` returns match (confirms existing behavior).
Verify `src/components/pet-svg/index.ts` exports both PetSVG and AnimatedPetSVG.
Verify ExpressionLayer has `pet-eyes` className on eye group elements.
  </verify>
  <done>
AnimatedPetSVG validates traits via loadTraits (PERSIST-01), then renders PetSVG with breathing animation, random blinking, tab pause, accessibility support, body-size timing, and unique per-pet phase offsets. PetSVG remains pure/memoized with className pass-through confirmed. ExpressionLayer eyes are targetable via CSS class. All existing tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify animations visually</name>
  <files>none (visual verification only)</files>
  <action>
Human verifies the complete idle animation system. What was built:
- Breathing animation: subtle scale transform over 3-4 second cycle, GPU-accelerated
- Blinking: random intervals 3-5 seconds, 200ms duration, eyes only
- Body-size timing: small=2.5s, medium=3.5s, large=4.5s breathing cycle
- Tab pause: animations pause when tab inactive via Page Visibility API
- Accessibility: animations disabled when prefers-reduced-motion is enabled
- Unique offsets: each pet starts at different animation phase via seedrandom

Verification steps:
1. Start the dev server: `npm run dev`
2. Navigate to any page that renders a PetSVG component, or create a quick test page
3. **Breathing (ANIM-01):** Observe pets subtly scaling in and out over ~3.5 seconds. Movement should be smooth, barely noticeable, organic
4. **Blinking (ANIM-02):** Watch for random blinks every 3-5 seconds. Each blink should be quick (~200ms). Only the eyes should blink, not the mouth
5. **Body size timing (ANIM-03):** If multiple pet sizes visible, small pets should breathe noticeably faster than large pets
6. **Tab pause (ANIM-04):** Switch to another tab for 5+ seconds, switch back. Pets should resume smoothly without jumping
7. **Accessibility (ANIM-05):** Enable "Reduce motion" in OS settings (macOS: System Settings > Accessibility > Display > Reduce motion). All pet animations should stop completely
8. **Unique offsets (ANIM-07):** If multiple pets visible on same page, they should NOT breathe in sync -- each should be at a different point in its breathing cycle
9. **GPU-only verification (ANIM-06):** Open Chrome DevTools > Performance tab. Click Record, wait 5 seconds with animations running, click Stop. In the flame chart, expand "Main" thread. There should be ZERO "Layout" or "Recalculate Style" events during animation frames. The only animation-related events should appear under "Compositor" as "Composite Layers". If you see Layout events, the animation is using non-GPU properties and must be fixed.
10. **CSS audit:** Open DevTools > Elements, inspect the animated SVG. Confirm only `transform` and `opacity` are being animated in the Computed styles -- no `width`, `height`, `top`, `left`, `margin`, or `padding` transitions
  </action>
  <verify>User types "approved" or describes issues to fix</verify>
  <done>All 7 ANIM requirements confirmed working via visual inspection. Animations are smooth, accessible, and performant.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vitest run` -- full test suite passes with zero regressions
3. AnimatedPetSVG renders breathing animation at 60fps using CSS transform only
4. Blink animation targets eye elements specifically via `.pet-eyes` CSS class
5. Tab visibility change pauses/resumes animation (no jumps)
6. prefers-reduced-motion disables all animations
7. Different pet IDs produce different animation offsets
8. Body size maps to breathing duration (2.5s/3.5s/4.5s)
</verification>

<success_criteria>
- All 7 ANIM requirements demonstrably met via visual verification
- GPU-only animation confirmed via DevTools (no layout thrashing)
- PetSVG React.memo optimization not broken (no unnecessary re-renders)
- Smooth 60fps animation on standard hardware
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-animation-persistence/03-02-SUMMARY.md`
</output>
