---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/pet-svg/BodyLayer.tsx
  - src/components/pet-svg/PatternLayer.tsx
  - src/components/pet-svg/AccessoryLayer.tsx
  - src/components/pet-svg/ExpressionLayer.tsx
  - src/components/pet-svg/PetSVG.tsx
  - src/components/pet-svg/index.ts
  - src/__tests__/components/PetSVG.test.tsx
autonomous: true

must_haves:
  truths:
    - "Pet renders as layered SVG with body, pattern, accessory, and expression visible in correct stacking order"
    - "Pet renders at three sizes (small 120px, medium 240px, large 480px) without pixelation using viewBox scaling"
    - "Missing or invalid traits produce a valid fallback pet rendering (not a crash or blank)"
    - "SVG rendering works independently of Three.js system with no import conflicts"
    - "Each trait category visually changes the pet appearance (different colors, patterns, accessories, expressions)"
  artifacts:
    - path: "src/components/pet-svg/BodyLayer.tsx"
      provides: "SVG body shape rendered with HSL color and body size scaling"
      exports: ["BodyLayer"]
    - path: "src/components/pet-svg/PatternLayer.tsx"
      provides: "SVG pattern overlay (stripes, spots, gradient) with pattern color"
      exports: ["PatternLayer"]
    - path: "src/components/pet-svg/AccessoryLayer.tsx"
      provides: "SVG accessories (horns, wings, crown, collar) positioned on body"
      exports: ["AccessoryLayer"]
    - path: "src/components/pet-svg/ExpressionLayer.tsx"
      provides: "SVG facial expressions (eyes, mouth) reflecting expression type"
      exports: ["ExpressionLayer"]
    - path: "src/components/pet-svg/PetSVG.tsx"
      provides: "Main composer component accepting PetTraits and size, rendering all layers"
      exports: ["PetSVG"]
    - path: "src/components/pet-svg/index.ts"
      provides: "Barrel export for PetSVG component"
      exports: ["PetSVG"]
    - path: "src/__tests__/components/PetSVG.test.tsx"
      provides: "Component tests for rendering, sizing, fallbacks"
      min_lines: 60
  key_links:
    - from: "src/components/pet-svg/PetSVG.tsx"
      to: "src/lib/traits/types.ts"
      via: "import PetTraits type for props"
      pattern: "import.*PetTraits.*traits/types"
    - from: "src/components/pet-svg/PetSVG.tsx"
      to: "src/lib/traits/colorHarmony.ts"
      via: "import hslToString for color conversion"
      pattern: "import.*hslToString.*colorHarmony"
    - from: "src/components/pet-svg/PetSVG.tsx"
      to: "src/components/pet-svg/BodyLayer.tsx"
      via: "renders BodyLayer as first SVG child"
      pattern: "<BodyLayer"
    - from: "src/components/pet-svg/PetSVG.tsx"
      to: "src/components/pet-svg/ExpressionLayer.tsx"
      via: "renders ExpressionLayer as last SVG child (top z-index)"
      pattern: "<ExpressionLayer"
---

<objective>
Build the SVG rendering system that composes pet visual traits into a layered, scalable graphic.

Purpose: This transforms abstract trait data (colors, patterns, accessories) into a visible pet that users see and connect with emotionally. The layered SVG approach ensures crisp rendering at any size, accessibility via aria labels, and performance through React.memo optimization.

Output: A PetSVG React component that accepts a PetTraits object and size prop, renders a visually distinctive pet as inline SVG with 4 composited layers, handles missing data gracefully, and coexists with the existing Three.js system.
</objective>

<execution_context>
@/Users/tarikstafford/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tarikstafford/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@src/lib/traits/types.ts
@src/lib/traits/colorHarmony.ts
@src/components/PetModel3D.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SVG layer components (Body, Pattern, Accessory, Expression)</name>
  <files>
    src/components/pet-svg/BodyLayer.tsx
    src/components/pet-svg/PatternLayer.tsx
    src/components/pet-svg/AccessoryLayer.tsx
    src/components/pet-svg/ExpressionLayer.tsx
  </files>
  <action>
    Create four React components in `src/components/pet-svg/` directory. Each component renders SVG elements within a `<g>` group tag (NOT standalone `<svg>` -- they compose inside the parent PetSVG's svg element).

    All components must be wrapped with React.memo for render optimization.
    All components import types from `@/lib/traits/types` (PetTraits, HSLColor, etc.).
    All components import `hslToString` from `@/lib/traits/colorHarmony` for color conversion.

    **BodyLayer.tsx:**
    - Props: `{ color: HSLColor; size: BodySize }`
    - Renders a pet body shape centered in a 100x100 viewBox coordinate space
    - Body is an ellipse (body) + circle (head) group, creating a simple creature silhouette
    - Size prop controls scale: small=0.8, medium=1.0, large=1.2 via transform scale
    - Body centered at (50, 55), head at (50, 35) -- head sits above body
    - Body ellipse: rx=22, ry=28; Head circle: r=16
    - Fill color from hslToString(color)
    - Add subtle stroke (1px, slightly darker version of body color: same hue, same sat, lightness - 15)

    **PatternLayer.tsx:**
    - Props: `{ type: PatternType; color: HSLColor; size: BodySize }`
    - If type is 'none', return null (render nothing)
    - Scale matches BodyLayer sizing (small=0.8, medium=1.0, large=1.2)
    - 'striped': Render 3-4 horizontal curved lines across the body ellipse area using `<path>` with stroke only (no fill), stroke-width 2, opacity 0.7
    - 'spotted': Render 5-7 small circles (r=2-4) scattered across body area with fill color, opacity 0.6
    - 'gradient': Use SVG `<linearGradient>` definition with body-to-pattern color transition, apply to an overlay ellipse matching body shape with opacity 0.5
    - Pattern elements must be clipped to body area using SVG `<clipPath>` referencing the body ellipse dimensions
    - Use unique IDs for SVG defs (gradient, clipPath) by incorporating a prefix like "pattern-" to avoid conflicts when multiple PetSVGs render on same page. Use React.useId() for unique IDs.

    **AccessoryLayer.tsx:**
    - Props: `{ type: AccessoryType; size: BodySize }`
    - If type is 'none', return null
    - Scale matches BodyLayer sizing
    - 'horns': Two small triangles (polygon) on top of head, positioned at head circle top-left and top-right, filled with a dark gray (#555)
    - 'wings': Two elliptical wing shapes on left and right sides of body, positioned at body mid-height, filled with lighter shade, opacity 0.6
    - 'crown': Three-pointed crown shape (polygon) centered on top of head, filled gold (#FFD700)
    - 'collar': An arc/ellipse around the neck area (between head and body), stroke only with a bright accent color (#E74C3C), stroke-width 2
    - Accessories should feel decorative but not overwhelm the body

    **ExpressionLayer.tsx:**
    - Props: `{ type: ExpressionType; size: BodySize }`
    - Scale matches BodyLayer sizing
    - All expressions have two eyes positioned on the head circle (left eye at ~x=44, right eye at ~x=56, y=33)
    - 'happy': Eyes as small filled circles (r=2.5, black), curved-up mouth arc below (path with upward curve at y=40)
    - 'neutral': Eyes as small filled circles, straight line mouth (y=40)
    - 'curious': Eyes slightly larger (r=3), one eyebrow raised (short line above one eye), small 'o' shaped mouth (small circle, r=1.5)
    - 'mischievous': Eyes as slightly angled ellipses (suggesting sly look), asymmetric smirk mouth (curved more on one side)
    - 'sleepy': Eyes as horizontal lines (closed eyes, short horizontal strokes), no mouth or gentle curve
    - Eye and mouth elements filled/stroked with #333 (dark but not pure black, softer look)
    - Add two small highlight dots on eyes (tiny white circles r=0.8) for liveliness -- skip for 'sleepy'

    IMPORTANT: SVG uses document order for z-index. These components render INSIDE the parent PetSVG which controls order: Body first (bottom), Pattern second, Accessory third, Expression last (top).
    IMPORTANT: Do NOT add 'use client' directive to these components -- they are pure render components with no client-side hooks (except useId in PatternLayer). The parent PetSVG will handle the client directive if needed.
    IMPORTANT: Keep SVG elements simple -- target 20-40 total SVG elements per pet max for performance.
  </action>
  <verify>
    `npx tsc --noEmit` compiles without errors.
    Each file exports a named, memoized React component.
    No Three.js imports in any SVG component file.
  </verify>
  <done>
    Four SVG layer components exist, each rendering distinct visual elements based on trait props, using consistent coordinate space (100x100 viewBox), with proper scaling for body size variants.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PetSVG composer component with barrel export and tests</name>
  <files>
    src/components/pet-svg/PetSVG.tsx
    src/components/pet-svg/index.ts
    src/__tests__/components/PetSVG.test.tsx
  </files>
  <action>
    **PetSVG.tsx -- Main composer component:**

    Create the top-level PetSVG component that composes all four layers into a complete pet rendering.

    Props interface (PetSVGProps):
    - `traits: PetTraits` -- full trait object from generation system
    - `size?: 'small' | 'medium' | 'large'` -- defaults to 'medium'
    - `className?: string` -- optional Tailwind/CSS classes
    - `showFallback?: boolean` -- if true, renders a default pet (for error states)

    Dimensions mapping:
    - small: width=120, height=120
    - medium: width=240, height=240
    - large: width=480, height=480

    Implementation:
    1. Define DEFAULT_TRAITS constant with sensible fallback values:
       - bodyColor: { h: 200, s: 65, l: 55 } (pleasant blue)
       - patternType: 'none'
       - accessory: 'none'
       - bodySize: 'medium'
       - expression: 'happy'
       - rarity: 'common'
       - traitVersion: 1
    2. Use try/catch around trait reading -- if any trait property access fails, fall back to DEFAULT_TRAITS
    3. Validate traits with PetTraitsSchema.safeParse() -- if validation fails, use DEFAULT_TRAITS and log a console.warn with the validation errors
    4. Render an `<svg>` element with:
       - width and height from size mapping
       - viewBox="0 0 100 100" (all layers use this coordinate space)
       - xmlns="http://www.w3.org/2000/svg"
       - role="img"
       - aria-label describing the pet (e.g., "A {rarity} pet with {expression} expression")
       - className prop passed through
    5. Render layers in order (document order = z-index):
       - `<BodyLayer color={traits.bodyColor} size={traits.bodySize} />`
       - `<PatternLayer type={traits.patternType} color={traits.patternColor || traits.bodyColor} size={traits.bodySize} />` (fallback pattern color to body color if missing)
       - `<AccessoryLayer type={traits.accessory} size={traits.bodySize} />`
       - `<ExpressionLayer type={traits.expression} size={traits.bodySize} />`
    6. Wrap the entire component with React.memo using custom comparison:
       - Compare traits via JSON.stringify (shallow comparison misses nested color objects)
       - Compare size directly
       - Skip className comparison (cosmetic, doesn't affect SVG content)

    Mark with 'use client' directive since it uses memo with custom comparison function.

    **index.ts -- Barrel export:**
    ```typescript
    export { PetSVG } from './PetSVG';
    export type { PetSVGProps } from './PetSVG';
    ```
    This allows importing as `import { PetSVG } from '@/components/pet-svg'`.

    **PetSVG.test.tsx -- Component tests:**

    Create test file using vitest + @testing-library/react (already in project).
    Test environment: jsdom (already configured in vitest.config.ts).

    Tests:
    - describe('PetSVG Rendering')
      - it('renders an SVG element with correct viewBox')
        - Render PetSVG with valid traits, assert `<svg>` element exists with viewBox="0 0 100 100"
      - it('renders at small size (120x120)')
        - Render with size="small", check svg width=120, height=120
      - it('renders at medium size (240x240) by default')
        - Render without size prop, check svg width=240, height=240
      - it('renders at large size (480x480)')
        - Render with size="large", check svg width=480, height=480
      - it('applies className prop to svg element')
        - Render with className="test-class", check svg has class
      - it('has accessible aria-label')
        - Render with traits, check role="img" and aria-label contains expression type

    - describe('PetSVG Fallback Behavior')
      - it('renders fallback pet when traits are undefined')
        - Render with traits as undefined (cast to bypass TS), verify SVG still renders without crash
      - it('renders fallback pet when traits fail validation')
        - Render with invalid traits object (wrong types), verify SVG still renders
      - it('logs warning when using fallback traits')
        - Spy on console.warn, render with invalid traits, verify warning was called

    - describe('PetSVG Layer Composition')
      - it('renders body layer with correct color')
        - Render with known traits, check that an ellipse element exists with the expected fill color
      - it('does not render pattern when type is none')
        - Render with patternType='none', verify no pattern-specific elements
      - it('does not render accessory when type is none')
        - Render with accessory='none', verify no accessory-specific elements

    - describe('PetSVG Three.js Coexistence')
      - it('does not import or reference Three.js')
        - This is a static analysis check: read the PetSVG.tsx file content and assert it does NOT contain 'three', '@react-three', or 'THREE' strings (can be done as a grep in test or just verified manually)

    Import PetTraits type from `@/lib/traits/types` and create test trait objects inline.
    Use `render()` from @testing-library/react and query using `screen.getByRole('img')`, `container.querySelector('svg')`, etc.

    IMPORTANT: Do NOT test individual layer component rendering in this test file -- those are internal implementation details. Test through the PetSVG public API only.
    IMPORTANT: Use the happy-dom or jsdom test environment already configured in vitest.config.ts.
  </action>
  <verify>
    `npx vitest run src/__tests__/components/PetSVG.test.tsx` -- all tests pass.
    `npx tsc --noEmit` -- no TypeScript errors.
    `import { PetSVG } from '@/components/pet-svg'` resolves correctly (verify via tsc).
  </verify>
  <done>
    PetSVG component renders pets as layered SVG at 3 sizes, handles invalid/missing traits with fallback defaults, has accessible markup, barrel-exported for clean imports, and verified by component tests. Zero Three.js dependencies.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run src/__tests__/components/PetSVG.test.tsx` -- all component tests pass
2. `npx tsc --noEmit` -- full project compiles with no errors
3. SVG renders at all three sizes without pixelation (viewBox-based scaling)
4. Invalid/missing traits produce a visible fallback pet (not crash/blank)
5. No imports from 'three', '@react-three/fiber', or '@react-three/drei' in any pet-svg/ file
6. Layer stacking order is visually correct: body behind pattern behind accessory behind expression
</verification>

<success_criteria>
- PetSVG component accepts PetTraits + size and renders a complete pet as inline SVG
- Three configurable sizes (small/medium/large) scale via viewBox without pixelation
- Four distinct visual layers compose in correct z-order
- Fallback defaults prevent crashes on bad/missing data
- Component tests pass covering rendering, sizing, fallbacks, and layer composition
- No Three.js coupling -- SVG system is fully independent
- Clean barrel export from src/components/pet-svg/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
