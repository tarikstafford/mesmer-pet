---
phase: 04-display-rollout
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/breed/page.tsx
  - src/app/friends/pets/[friendId]/page.tsx
  - src/components/MarketplaceCard.tsx
  - src/app/pets/marketplace/page.tsx
autonomous: false

must_haves:
  truths:
    - "Breed page renders AnimatedPetSVG for both parent pet previews"
    - "Friends pet page renders AnimatedPetSVG in pet grid"
    - "Marketplace listings show animated pet SVG instead of static image placeholder"
    - "Zero PetModel3D references remain in any page component (excluding ARPetViewer and tests)"
    - "No visual regressions in layout or sizing across all replaced contexts"
  artifacts:
    - path: "src/app/breed/page.tsx"
      provides: "Breed page with AnimatedPetSVG for parent previews"
      contains: "AnimatedPetSVG"
    - path: "src/app/friends/pets/[friendId]/page.tsx"
      provides: "Friends page with AnimatedPetSVG in pet grid"
      contains: "AnimatedPetSVG"
    - path: "src/components/MarketplaceCard.tsx"
      provides: "MarketplaceCard with AnimatedPetSVG pet rendering"
      contains: "AnimatedPetSVG"
    - path: "src/app/pets/marketplace/page.tsx"
      provides: "Marketplace page passing pet data to MarketplaceCard"
      contains: "petId.*listing.pet.id"
  key_links:
    - from: "src/app/breed/page.tsx"
      to: "src/components/pet-svg/AnimatedPetSVG.tsx"
      via: "import { AnimatedPetSVG }"
      pattern: "AnimatedPetSVG.*petId.*traits"
    - from: "src/app/friends/pets/[friendId]/page.tsx"
      to: "src/components/pet-svg/AnimatedPetSVG.tsx"
      via: "import { AnimatedPetSVG }"
      pattern: "AnimatedPetSVG.*petId.*traits"
    - from: "src/components/MarketplaceCard.tsx"
      to: "src/components/pet-svg/AnimatedPetSVG.tsx"
      via: "import { AnimatedPetSVG }"
      pattern: "AnimatedPetSVG.*petId.*traits"
    - from: "src/app/pets/marketplace/page.tsx"
      to: "src/components/MarketplaceCard.tsx"
      via: "petId and petTraits props"
      pattern: "petId=.*petTraits="
---

<objective>
Replace PetModel3D in breed page, friends page, and add pet rendering to marketplace — completing the display rollout across all remaining contexts.

Purpose: Eliminates every remaining white polygon placeholder in the app. After this plan, zero PetModel3D references exist in user-facing page components (DISPLAY-03, DISPLAY-04, DISPLAY-05, DISPLAY-06).

Output: All pet display contexts render animated SVG pets. Visual verification confirms no regressions.
</objective>

<execution_context>
@/Users/tarikstafford/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tarikstafford/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-display-rollout/04-RESEARCH.md
@.planning/phases/04-display-rollout/04-01-SUMMARY.md
@src/components/pet-svg/AnimatedPetSVG.tsx
@src/lib/traits/migration.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace PetModel3D in breed page and friends page</name>
  <files>src/app/breed/page.tsx, src/app/friends/pets/[friendId]/page.tsx</files>
  <action>
Replace PetModel3D with AnimatedPetSVG in the breeding interface and friend pet viewing page.

## Breed page (src/app/breed/page.tsx)

**Step 1: Update imports**
- Remove the `PetModel3D` dynamic import (lines 7-10: `const PetModel3D = dynamic(...)`)
- Remove `dynamic` import from 'next/dynamic' if no other dynamic imports remain
- Keep `Suspense` only if used elsewhere in the file
- Add:
  ```tsx
  import { AnimatedPetSVG } from '@/components/pet-svg/AnimatedPetSVG'
  import { loadTraits } from '@/lib/traits/migration'
  ```

**Step 2: Update Pet interface**
- Add `traits` field to the Pet interface in this file:
  ```tsx
  traits?: Record<string, unknown> | null
  ```
  The API already returns this field (Prisma scalar).

**Step 3: Replace Parent 1 rendering (around line 291-298)**

Current:
```tsx
<div className="mb-4 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-2xl overflow-hidden border-2 border-purple-200">
  <PetModel3D
    traitNames={getPet(selectedPet1)!.petTraits
      .filter((pt) => pt.trait.traitType === 'visual')
      .map((pt) => pt.trait.traitName)}
    health={getPet(selectedPet1)!.health}
  />
</div>
```

Replace with:
```tsx
<div className="mb-4 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-2xl overflow-hidden border-2 border-purple-200">
  <div className="w-full h-[200px] flex items-center justify-center">
    <AnimatedPetSVG
      petId={getPet(selectedPet1)!.id}
      traits={loadTraits(getPet(selectedPet1)!.traits, getPet(selectedPet1)!.id)}
      size="medium"
    />
  </div>
</div>
```

**Step 4: Replace Parent 2 rendering (around line 346-353)**

Current:
```tsx
<div className="mb-4 bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 rounded-2xl overflow-hidden border-2 border-pink-200">
  <PetModel3D
    traitNames={getPet(selectedPet2)!.petTraits
      .filter((pt) => pt.trait.traitType === 'visual')
      .map((pt) => pt.trait.traitName)}
    health={getPet(selectedPet2)!.health}
  />
</div>
```

Replace with:
```tsx
<div className="mb-4 bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 rounded-2xl overflow-hidden border-2 border-pink-200">
  <div className="w-full h-[200px] flex items-center justify-center">
    <AnimatedPetSVG
      petId={getPet(selectedPet2)!.id}
      traits={loadTraits(getPet(selectedPet2)!.traits, getPet(selectedPet2)!.id)}
      size="medium"
    />
  </div>
</div>
```

**Key:** Use `size="medium"` for breed page (smaller preview context). Keep container background classes. Add inner centering div with explicit height matching the PetModel3D loading fallback height (h-[200px]).

## Friends page (src/app/friends/pets/[friendId]/page.tsx)

**Step 1: Update imports**
- Remove `PetModel3D` dynamic import (line 7)
- Remove `dynamic` import from 'next/dynamic' if unused
- Add:
  ```tsx
  import { AnimatedPetSVG } from '@/components/pet-svg/AnimatedPetSVG'
  import { loadTraits } from '@/lib/traits/migration'
  ```

**Step 2: Update Pet interface**
- Add `traits` field to the Pet interface in this file:
  ```tsx
  traits?: Record<string, unknown> | null
  ```

**Step 3: Replace rendering in pet grid (around line 227-234)**

Current:
```tsx
{/* Pet 3D Model */}
<div className="mb-4 h-64 bg-gray-50 rounded-lg overflow-hidden">
  <PetModel3D
    traitNames={pet.petTraits
      .filter((pt) => pt.trait.traitType === 'visual')
      .map((pt) => pt.trait.traitName)}
    health={pet.health}
  />
</div>
```

Replace with:
```tsx
{/* Animated Pet SVG */}
<div className="mb-4 h-64 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-lg overflow-hidden flex items-center justify-center">
  <AnimatedPetSVG
    petId={pet.id}
    traits={loadTraits(pet.traits, pet.id)}
    size="medium"
  />
</div>
```

**Key:** Replace `bg-gray-50` with the project's standard pet display gradient (`bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100`) for visual consistency with dashboard and breed page. Keep `h-64` container height. Add `flex items-center justify-center` for centering.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero TypeScript errors.
Run `npx vitest run` — all tests pass with zero regressions.
Grep for "PetModel3D" in src/app/breed/page.tsx — zero matches.
Grep for "PetModel3D" in src/app/friends/pets/[friendId]/page.tsx — zero matches.
  </verify>
  <done>
Breed page renders AnimatedPetSVG for both parent previews. Friends page renders AnimatedPetSVG in pet grid. Both use loadTraits for trait validation. Container dimensions preserved. Zero PetModel3D references in either file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pet rendering to MarketplaceCard and marketplace page</name>
  <files>src/components/MarketplaceCard.tsx, src/app/pets/marketplace/page.tsx</files>
  <action>
Add AnimatedPetSVG rendering to the MarketplaceCard component and pass pet data from the marketplace page. Currently MarketplaceCard uses an optional `petImage` string (static image) — replace this with animated SVG pet rendering.

## MarketplaceCard (src/components/MarketplaceCard.tsx)

**Step 1: Add imports**
- Add at top of file (after 'use client'):
  ```tsx
  import { AnimatedPetSVG } from '@/components/pet-svg/AnimatedPetSVG'
  import { loadTraits } from '@/lib/traits/migration'
  ```

**Step 2: Update MarketplaceCardProps interface (around line 8)**
- Add two new props and deprecate petImage:
  ```tsx
  interface MarketplaceCardProps {
    listingId: string;
    petName: string;
    petImage?: string;           // Keep for backward compatibility but unused
    petId?: string;              // ADD: Pet ID for trait loading and animation
    petTraits?: Record<string, unknown> | null;  // ADD: Pet traits JSON from database
    price: number;
    sellerName: string;
    sellerId: string;
    isSold?: boolean;
    currentUserId?: string;
    userCurrency?: number;
    onPurchase?: (listingId: string) => void;
    loading?: boolean;
  }
  ```

**Step 3: Destructure new props (around line 22)**
- Add `petId` and `petTraits` to destructured props.

**Step 4: Replace Pet Image section (around lines 62-70)**

Current:
```tsx
{/* Pet Image */}
{petImage && (
  <div className="pet-image mb-4">
    <img
      src={petImage}
      alt={petName}
      className="w-full h-48 object-cover rounded-xl"
    />
  </div>
)}
```

Replace with:
```tsx
{/* Pet Display */}
<div className="pet-display mb-4 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-xl overflow-hidden shadow-inner border-2 border-purple-200">
  <div className="w-full h-48 flex items-center justify-center">
    {petId ? (
      <AnimatedPetSVG
        petId={petId}
        traits={loadTraits(petTraits, petId)}
        size="medium"
      />
    ) : petImage ? (
      <img
        src={petImage}
        alt={petName}
        className="w-full h-48 object-cover"
      />
    ) : (
      <div className="text-gray-400 text-sm">No pet preview</div>
    )}
  </div>
</div>
```

**Key design decisions:**
- Always render the pet display container (not conditional on petImage) — every marketplace listing should show the pet
- Fallback chain: AnimatedPetSVG (if petId provided) → static image (if petImage provided) → placeholder text
- Use `size="medium"` for card context
- Keep `h-48` to match original image height
- Add standard gradient background and border consistent with other pet display contexts

## Marketplace page (src/app/pets/marketplace/page.tsx)

**Step 1: Update Pet interface (around line 19)**
- The current Pet interface has `id`, `name`, and `traits` (which is actually `PetTrait[]` for the relation). But the API returns the full Pet object including the `traits` JSON scalar field. Update the interface:
  ```tsx
  interface Pet {
    id: string;
    name: string;
    traits: unknown;  // JSON scalar field (visual appearance traits)
  }
  ```
  Note: The existing `traits: PetTrait[]` field in the interface was mapping to the relation data, but the actual API response (`prisma.pet.findUnique` without `include`) returns the `traits` JSON scalar, not the relation. Rename or restructure to match the actual API response.

**Step 2: Update MarketplaceCard usage (around lines 222-234)**

Current:
```tsx
<MarketplaceCard
  key={listing.id}
  listingId={listing.id}
  petName={listing.pet.name}
  price={listing.price}
  sellerName={listing.seller.name}
  sellerId={listing.sellerId}
  isSold={listing.status === 'sold'}
  currentUserId={currentUserId || undefined}
  userCurrency={userCurrency}
  onPurchase={handlePurchase}
  loading={purchasingId === listing.id}
/>
```

Replace with:
```tsx
<MarketplaceCard
  key={listing.id}
  listingId={listing.id}
  petName={listing.pet.name}
  petId={listing.pet.id}
  petTraits={listing.pet.traits as Record<string, unknown> | null}
  price={listing.price}
  sellerName={listing.seller.name}
  sellerId={listing.sellerId}
  isSold={listing.status === 'sold'}
  currentUserId={currentUserId || undefined}
  userCurrency={userCurrency}
  onPurchase={handlePurchase}
  loading={purchasingId === listing.id}
/>
```

**Key:** The marketplace listings API (`/api/pets/marketplace/listings`) returns the full pet object via `prisma.pet.findUnique`, which includes the `traits` JSON scalar field. The `listing.pet.traits` value will be the JSON object or null. Cast to `Record<string, unknown> | null` for type safety. `loadTraits` inside MarketplaceCard handles null/undefined gracefully.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero TypeScript errors.
Run `npx vitest run` — all tests pass with zero regressions.
Grep for "AnimatedPetSVG" in src/components/MarketplaceCard.tsx — returns matches.
Grep for "petId" in src/app/pets/marketplace/page.tsx — returns matches showing petId prop passed.
  </verify>
  <done>
MarketplaceCard renders AnimatedPetSVG for each listing. Marketplace page passes petId and petTraits to MarketplaceCard. Fallback rendering maintained for listings without pet data. All tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify zero white polygon pets across all contexts</name>
  <files>none (verification only)</files>
  <action>
This is a human verification checkpoint. AnimatedPetSVG now replaces PetModel3D across all user-facing contexts:
1. Dashboard pet grid (04-01)
2. PetCard component (04-01)
3. Breed page parent previews (04-02)
4. Friends pet grid (04-02)
5. Marketplace listings (04-02)

PetModel3D is preserved ONLY in ARPetViewer.tsx (AR feature, not a "placeholder").

Verification steps:
1. Start the dev server: `npm run dev`
2. Log in and go to the Dashboard — verify pets show animated SVGs (breathing, blinking), NOT white 3D polygons
3. Click a pet card — verify PetCard renders animated SVG
4. Navigate to Breed page (/breed) — select two pets, verify both parent previews show animated SVGs
5. Navigate to Friends page and view a friend's pets — verify pet grid shows animated SVGs
6. Navigate to Marketplace (/pets/marketplace) — verify listings show animated pet SVGs
7. Check animations: pets should breathe subtly and blink randomly
8. Check layout: no visual jumps, no broken grids, no scroll changes, no missing pet displays
9. Check browser console: no React hydration errors, no "Cannot read property" errors from null traits
  </action>
  <verify>User types "approved" if all contexts render animated SVGs with no white polygons remaining, or describes any issues found.</verify>
  <done>All 5 display contexts render animated SVG pets. Zero white polygon pets visible. No visual regressions. No console errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — TypeScript compiles with zero errors
2. `npx vitest run` — All tests pass with zero regressions
3. `grep -rn "PetModel3D" src/app/ src/components/ --include="*.tsx" | grep -v "ARPetViewer" | grep -v ".backup" | grep -v "__tests__"` — returns zero results (no PetModel3D in any page except AR viewer)
4. `grep -rn "AnimatedPetSVG" src/app/ src/components/ --include="*.tsx" | grep -v "__tests__"` — returns matches in dashboard, PetCard, breed, friends, MarketplaceCard
5. Visual verification: all 5 display contexts render animated SVG pets
</verification>

<success_criteria>
- Breed page renders AnimatedPetSVG for both parent previews (DISPLAY-04)
- Friends page renders AnimatedPetSVG in pet grid (DISPLAY-04)
- Marketplace listings show animated pet SVG rendering (DISPLAY-03)
- Zero PetModel3D references in any user-facing page component except ARPetViewer (DISPLAY-05)
- No visual regressions in layout or sizing (DISPLAY-06)
- Human verification confirms all contexts render correctly
- All existing tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-display-rollout/04-02-SUMMARY.md`
</output>
