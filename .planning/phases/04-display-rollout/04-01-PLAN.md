---
phase: 04-display-rollout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/dashboard/page.tsx
  - src/components/PetCard.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard pet grid renders AnimatedPetSVG instead of PetModel3D for every pet"
    - "PetCard component renders AnimatedPetSVG instead of PetModel3D"
    - "Pet traits are loaded via loadTraits utility (never direct access)"
    - "Container dimensions and layout classes are preserved exactly (no visual regression)"
  artifacts:
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard with AnimatedPetSVG replacing PetModel3D"
      contains: "AnimatedPetSVG"
    - path: "src/components/PetCard.tsx"
      provides: "PetCard with AnimatedPetSVG replacing PetModel3D"
      contains: "AnimatedPetSVG"
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "src/components/pet-svg/AnimatedPetSVG.tsx"
      via: "import { AnimatedPetSVG }"
      pattern: "AnimatedPetSVG.*petId.*traits"
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/traits/migration.ts"
      via: "import { loadTraits }"
      pattern: "loadTraits\\(pet\\.traits"
    - from: "src/components/PetCard.tsx"
      to: "src/components/pet-svg/AnimatedPetSVG.tsx"
      via: "import { AnimatedPetSVG }"
      pattern: "AnimatedPetSVG.*petId.*traits"
---

<objective>
Replace PetModel3D with AnimatedPetSVG in the dashboard page and PetCard component — the two primary pet display contexts.

Purpose: Dashboard and PetCard are the most-viewed pet rendering locations. Replacing them eliminates white polygon placeholders from the main user experience (DISPLAY-01, DISPLAY-02).

Output: Dashboard pet grid and PetCard component render animated SVG pets using traits from database JSON field.
</objective>

<execution_context>
@/Users/tarikstafford/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tarikstafford/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-display-rollout/04-RESEARCH.md
@.planning/phases/03-animation-persistence/03-02-SUMMARY.md
@src/components/pet-svg/AnimatedPetSVG.tsx
@src/lib/traits/migration.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace PetModel3D with AnimatedPetSVG in dashboard page</name>
  <files>src/app/dashboard/page.tsx</files>
  <action>
Replace the PetModel3D 3D rendering in the dashboard pet grid with AnimatedPetSVG.

**Step 1: Update imports (top of file)**
- Remove the `PetModel3D` dynamic import block (lines 8-16: `const PetModel3D = dynamic(...)`)
- Remove the `Suspense` import from React (line 3) ONLY if Suspense is not used elsewhere in the file. If Suspense is used elsewhere, keep it.
- Remove the `dynamic` import from 'next/dynamic' (line 6) ONLY if no other dynamic imports remain. Check for `ChatInterface` dynamic import — if it exists, keep `dynamic`.
- Add imports:
  ```tsx
  import { AnimatedPetSVG } from '@/components/pet-svg/AnimatedPetSVG'
  import { loadTraits } from '@/lib/traits/migration'
  ```
- Add `useMemo` to the React import if not already present.

**Step 2: Update Pet interface (around line 127)**
- Add `traits` field to the Pet interface:
  ```tsx
  traits?: Record<string, unknown> | null  // Visual appearance traits JSON
  ```
  This field is already returned by the API (Prisma includes all scalar fields when using `include`), but the frontend interface doesn't declare it.

**Step 3: Replace rendering in pet grid (around lines 981-990)**

Current code:
```tsx
{/* 3D Pet Model */}
<div className="mb-6 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-2xl overflow-hidden shadow-inner border-2 border-purple-200">
  <Suspense fallback={
    <div className="w-full h-72 flex items-center justify-center">
      <div className="text-gray-400 animate-pulse">Loading 3D model...</div>
    </div>
  }>
    <PetModel3D traitNames={visualTraitNames} health={pet.health} width={350} height={280} autoRotate={true} />
  </Suspense>
</div>
```

Replace with:
```tsx
{/* Animated Pet SVG */}
<div className="mb-6 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-2xl overflow-hidden shadow-inner border-2 border-purple-200">
  <div className="w-full h-72 flex items-center justify-center">
    <AnimatedPetSVG
      petId={pet.id}
      traits={loadTraits(pet.traits, pet.id)}
      size="large"
    />
  </div>
</div>
```

**Key preservation rules:**
- Keep the outer container div with ALL existing classes (`mb-6 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-2xl overflow-hidden shadow-inner border-2 border-purple-200`)
- Keep the inner centering div with `w-full h-72 flex items-center justify-center`
- Remove the Suspense wrapper (SVG loads instantly, no dynamic import)
- Remove the `visualTraitNames` extraction code (around line 915-917: `const visualTraitNames = pet.petTraits.filter(...)...`) since it's no longer used. BUT first check if `visualTraitNames` is referenced elsewhere in the same pet card rendering block — if so, keep it.
- Use `loadTraits(pet.traits, pet.id)` — this handles null/undefined traits gracefully by regenerating from petId seed
- Use `size="large"` for dashboard pet display (matches the 350x280 area)

**Important:** The dashboard page is 'use client' already (line 1), so no directive changes needed. AnimatedPetSVG also has 'use client', so no hydration issues.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero TypeScript errors.
Run `npx vitest run` — all existing tests pass with zero regressions.
Grep for "PetModel3D" in src/app/dashboard/page.tsx — should return zero matches.
Grep for "AnimatedPetSVG" in src/app/dashboard/page.tsx — should return matches.
  </verify>
  <done>
Dashboard page imports AnimatedPetSVG instead of PetModel3D. Pet grid renders animated SVG pets using loadTraits. Container dimensions preserved. TypeScript compiles. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace PetModel3D with AnimatedPetSVG in PetCard component</name>
  <files>src/components/PetCard.tsx</files>
  <action>
Replace PetModel3D in the PetCard reusable component with AnimatedPetSVG.

**Step 1: Update imports (top of file)**
- Remove the `PetModel3D` dynamic import block (lines 7-14: `const PetModel3D = dynamic(...)`)
- Remove the `dynamic` import from 'next/dynamic' (line 3) if no other dynamic imports exist in the file.
- Remove the `Suspense` import from React (line 4) if Suspense is not used elsewhere in the file.
- Add imports:
  ```tsx
  import { AnimatedPetSVG } from '@/components/pet-svg/AnimatedPetSVG'
  import { loadTraits } from '@/lib/traits/migration'
  import { useMemo } from 'react'
  ```
  (Add `useMemo` to existing React import if one exists, rather than a separate import.)

**Step 2: Update PetCardProps interface (around line 49)**
- Add `traits` optional prop to PetCardProps:
  ```tsx
  traits?: Record<string, unknown> | null  // Visual appearance traits JSON from database
  ```
  Place it after the `petTraits` field for logical grouping.

**Step 3: Destructure new prop (around line 85)**
- Add `traits` to the destructured props.

**Step 4: Add memoized trait loading (inside component, before return)**
- Add after props destructuring:
  ```tsx
  const validatedTraits = useMemo(
    () => loadTraits(traits, id),
    [traits, id]
  )
  ```
  This validates and migrates traits, falling back to deterministic generation from pet ID if traits are null.

**Step 5: Replace rendering (around lines 243-252)**

Current code:
```tsx
{/* 3D Pet Model */}
<div className="mb-6 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-2xl overflow-hidden shadow-inner border-2 border-purple-200" data-testid="pet-model">
  <Suspense fallback={
    <div className="w-full h-72 flex items-center justify-center">
      <div className="text-gray-400 animate-pulse">Loading 3D model...</div>
    </div>
  }>
    <PetModel3D traitNames={visualTraitNames} health={health} width={350} height={280} autoRotate={true} />
  </Suspense>
</div>
```

Replace with:
```tsx
{/* Animated Pet SVG */}
<div className="mb-6 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-2xl overflow-hidden shadow-inner border-2 border-purple-200" data-testid="pet-model">
  <div className="w-full h-72 flex items-center justify-center">
    <AnimatedPetSVG
      petId={id}
      traits={validatedTraits}
      size="large"
    />
  </div>
</div>
```

**Key preservation rules:**
- Keep data-testid="pet-model" on container (tests may reference it)
- Keep ALL container classes unchanged
- Keep inner centering div with `w-full h-72`
- Remove the `visualTraitNames` extraction (line 172-174) ONLY if it's not used elsewhere in the component. Search the file for other references to `visualTraitNames` before removing.

**Step 6: Update PetCard test file**
- Check `src/__tests__/components/PetCard.test.tsx` for references to PetModel3D or Suspense mocking
- If tests mock PetModel3D, update mocks to mock AnimatedPetSVG instead:
  ```tsx
  vi.mock('@/components/pet-svg/AnimatedPetSVG', () => ({
    AnimatedPetSVG: ({ petId, size }: { petId: string; size: string }) => (
      <div data-testid="animated-pet-svg" data-pet-id={petId} data-size={size} />
    ),
  }))
  ```
- If tests reference "Loading 3D model" text, remove those assertions
- Add `traits: null` to test pet data objects where PetCardProps are constructed (loadTraits handles null gracefully)
  </action>
  <verify>
Run `npx tsc --noEmit` — zero TypeScript errors.
Run `npx vitest run src/__tests__/components/PetCard.test.tsx` — all PetCard tests pass.
Run `npx vitest run` — all tests pass with zero regressions.
Grep for "PetModel3D" in src/components/PetCard.tsx — should return zero matches.
Grep for "AnimatedPetSVG" in src/components/PetCard.tsx — should return matches.
  </verify>
  <done>
PetCard component imports AnimatedPetSVG instead of PetModel3D. Traits loaded via loadTraits with useMemo for stable references. Container dimensions and data-testid preserved. All tests pass including PetCard-specific tests.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — TypeScript compiles with zero errors
2. `npx vitest run` — All tests pass with zero regressions
3. `grep -r "PetModel3D" src/app/dashboard/page.tsx src/components/PetCard.tsx` — returns zero results
4. `grep -r "AnimatedPetSVG" src/app/dashboard/page.tsx src/components/PetCard.tsx` — returns matches in both files
5. `grep -r "loadTraits" src/app/dashboard/page.tsx src/components/PetCard.tsx` — returns matches in both files
</verification>

<success_criteria>
- Dashboard pet grid renders AnimatedPetSVG (no PetModel3D references remain)
- PetCard component renders AnimatedPetSVG (no PetModel3D references remain)
- Both use loadTraits for trait validation (never direct trait access)
- Container dimensions identical to original (no layout shift)
- All existing tests pass with zero regressions
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-display-rollout/04-01-SUMMARY.md`
</output>
