---
phase: 02-database-integration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/genetics.ts
  - src/app/api/pets/route.ts
autonomous: true

must_haves:
  truths:
    - "New pet creation automatically generates and persists visual traits to database"
    - "Created pets have valid trait JSON immediately after creation (no null traits)"
    - "Trait data is validated with Zod before database save (prevents invalid traits)"
    - "Created pets display with full visual features when fetched from API"
  artifacts:
    - path: "src/lib/genetics.ts"
      provides: "Updated createPetWithGenetics with trait generation"
      contains: "generatePetTraits"
    - path: "src/app/api/pets/route.ts"
      provides: "Pet API returning traits in response"
      contains: "traits"
  key_links:
    - from: "src/lib/genetics.ts"
      to: "src/lib/traits/generation.ts"
      via: "imports generatePetTraits"
      pattern: "import.*generatePetTraits.*from.*traits/generation"
    - from: "src/lib/genetics.ts"
      to: "src/lib/traits/validation.ts"
      via: "imports PetTraitsSchema for validation"
      pattern: "import.*PetTraitsSchema.*from.*traits/validation"
    - from: "src/app/api/pets/route.ts"
      to: "src/lib/genetics.ts"
      via: "calls createPetWithGenetics which now includes traits"
      pattern: "createPetWithGenetics"
---

<objective>
Update pet creation flow to automatically generate, validate, and persist visual traits when new pets are created.

Purpose: After migration backfills existing pets, the creation flow must also generate traits so every new pet immediately displays with full visual features. Without this, newly created pets would have null traits while old pets have them.
Output: Updated genetics.ts with trait generation in createPetWithGenetics, API route returning traits data.
</objective>

<execution_context>
@/Users/tarikstafford/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tarikstafford/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-integration/02-01-SUMMARY.md
@src/lib/genetics.ts
@src/app/api/pets/route.ts
@src/lib/traits/generation.ts
@src/lib/traits/validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update createPetWithGenetics to generate and save visual traits</name>
  <files>src/lib/genetics.ts</files>
  <action>
    1. Add imports at the top of `src/lib/genetics.ts`:
       ```
       import { generatePetTraits } from './traits/generation';
       import { PetTraitsSchema } from './traits/validation';
       ```

    2. Modify the `createPetWithGenetics` function to generate traits during pet creation. In the `prisma.pet.create()` call, add `traits` to the `data` object:
       ```
       const pet = await prisma.pet.create({
         data: {
           name: petName,
           userId,
           generation: 1,
           friendliness: personality.friendliness,
           energyTrait: personality.energyTrait,
           curiosity: personality.curiosity,
           patience: personality.patience,
           playfulness: personality.playfulness,
           // Generate and validate visual traits from pet ID
           // Uses pet's UUID as seed for deterministic generation
           traits: PetTraitsSchema.parse(generatePetTraits(crypto.randomUUID())),
         },
       });
       ```

       IMPORTANT: The pet ID is auto-generated by Prisma (`@default(uuid())`), so we don't have it before creation. We need to use a separate UUID as the trait seed. Generate it with `crypto.randomUUID()` and pass it as the seed. This means the trait seed differs from the pet ID, but that's acceptable -- traits are still deterministic per seed and stored in the database. The backfill script used pet IDs because those already existed.

       Alternative approach (preferred if cleaner): Generate the pet ID manually before creation so traits can be seeded from the actual pet ID:
       ```
       const petId = crypto.randomUUID();
       const traits = PetTraitsSchema.parse(generatePetTraits(petId));

       const pet = await prisma.pet.create({
         data: {
           id: petId,
           name: petName,
           userId,
           generation: 1,
           friendliness: personality.friendliness,
           energyTrait: personality.energyTrait,
           curiosity: personality.curiosity,
           patience: personality.patience,
           playfulness: personality.playfulness,
           traits,
         },
       });
       ```
       Use this approach -- it keeps the petId-as-seed pattern consistent with the backfill script, making traits reproducible from the pet ID alone.

    3. Do NOT modify `generateRandomPersonality()` or `assignRandomTraits()` -- those handle the separate PetTrait relational system and are unrelated to visual traits.

    4. Do NOT remove or modify any existing fields in the create call.

    Avoid: Do NOT use Math.random() for trait generation. Do NOT skip Zod validation before passing to Prisma.
  </action>
  <verify>
    1. TypeScript compilation succeeds: `npx tsc --noEmit --pretty 2>&1 | head -20`
    2. Existing tests still pass: `npx vitest run --reporter=verbose 2>&1 | tail -30`
    3. File contains both `generatePetTraits` and `PetTraitsSchema` imports
  </verify>
  <done>createPetWithGenetics generates a deterministic pet ID, creates validated visual traits from that ID, and saves traits JSON alongside all other pet data in a single create call. Trait data is Zod-validated before database insert.</done>
</task>

<task type="auto">
  <name>Task 2: Verify API route returns traits and test end-to-end creation</name>
  <files>src/app/api/pets/route.ts</files>
  <action>
    1. Read the current `src/app/api/pets/route.ts` GET handler. Verify that the `prisma.pet.findMany()` call does NOT explicitly exclude traits. Since Prisma returns all scalar fields by default and `traits` is a scalar Json field, it should already be included in responses without code changes.

    2. If the GET handler uses a `select` clause that would exclude traits, add `traits: true` to the select. If it uses `include` (which it does for petTraits and petSkills), traits should already be returned as a scalar field. Verify this is the case.

    3. The POST handler calls `createPetWithGenetics()` which now returns a pet with traits. The existing response (`{ message, pet }`) will include traits automatically. No changes needed to the POST handler.

    4. Run a quick integration verification:
       - Start the dev server or use the existing test infrastructure
       - Check that `npx vitest run src/__tests__/api/pets.test.ts` still passes
       - If the test creates pets and checks the response, verify it doesn't break on the new traits field

    5. If there are test failures due to the new `traits` field in responses, update the tests to expect/accommodate the traits field. Do NOT remove the traits field to fix tests -- update tests instead.

    6. Verify no TypeScript errors across the project: `npx tsc --noEmit`

    Avoid: Do NOT modify the validation schema for the POST request (createPetSchema). Traits are auto-generated, not user-supplied. Do NOT add traits to the request body validation.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes with no errors
    2. `npx vitest run --reporter=verbose 2>&1 | tail -30` -- all tests pass
    3. The GET handler returns pets with traits field (inspect prisma.pet.findMany call - no select clause excluding traits)
    4. The POST handler response includes traits in the created pet object
  </verify>
  <done>API endpoints return pet data including visual traits. POST /api/pets creates pets with auto-generated traits. GET /api/pets returns traits alongside other pet data. All existing tests pass without regressions.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no TypeScript errors
2. `npx vitest run --reporter=verbose` -- all tests pass
3. Create a test pet via the API or test suite -- verify traits field is non-null in response
4. Verify traits are valid JSON matching PetTraitsSchema shape
</verification>

<success_criteria>
- createPetWithGenetics generates and saves traits for every new pet
- Traits are Zod-validated before database insert
- API POST /api/pets response includes traits
- API GET /api/pets response includes traits for all pets
- No regressions in existing tests
- Zero new pets can be created without traits
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-integration/02-02-SUMMARY.md`
</output>
