---
phase: 05-performance-quality
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/pets/marketplace/page.tsx
  - src/components/MarketplaceCard.tsx
  - src/app/friends/pets/[friendId]/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Pet marketplace page uses LazyPetGrid for viewport culling when displaying 20+ listings"
    - "Friends pet view page uses LazyPetGrid for viewport culling when displaying pets"
    - "Off-screen pets render as placeholder skeletons instead of AnimatedPetSVG (no wasted animation GPU cycles)"
  artifacts:
    - path: "src/app/pets/marketplace/page.tsx"
      provides: "LazyPetGrid integration replacing direct grid mapping"
      contains: "LazyPetGrid"
    - path: "src/components/MarketplaceCard.tsx"
      provides: "Optional petSvgNode prop for external SVG injection"
      contains: "petSvgNode"
    - path: "src/app/friends/pets/[friendId]/page.tsx"
      provides: "LazyPetGrid integration replacing direct grid mapping"
      contains: "LazyPetGrid"
  key_links:
    - from: "src/app/pets/marketplace/page.tsx"
      to: "src/components/pet-svg/LazyPetGrid.tsx"
      via: "import { LazyPetGrid } from '@/components/pet-svg'"
      pattern: "LazyPetGrid"
    - from: "src/app/pets/marketplace/page.tsx"
      to: "src/components/MarketplaceCard.tsx"
      via: "renderCard prop passes petSvg into MarketplaceCard"
      pattern: "renderCard.*MarketplaceCard"
    - from: "src/app/friends/pets/[friendId]/page.tsx"
      to: "src/components/pet-svg/LazyPetGrid.tsx"
      via: "import { LazyPetGrid } from '@/components/pet-svg'"
      pattern: "LazyPetGrid"
---

<objective>
Integrate LazyPetGrid viewport culling into pet marketplace and friends pet view pages, closing the PERF-04 gap where the component exists but is orphaned.

Purpose: LazyPetGrid was created in plan 05-03 but never integrated into actual pages. Views with 20+ pets still render all AnimatedPetSVG simultaneously without viewport culling. This plan wires the existing component into the two pages that can display 20+ pets.

Output: Marketplace and friends pet view pages use LazyPetGrid, achieving actual viewport culling for large pet collections.
</objective>

<execution_context>
@/Users/tarikstafford/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tarikstafford/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-performance-quality/05-03-SUMMARY.md
@src/components/pet-svg/LazyPetGrid.tsx
@src/components/pet-svg/index.ts
@src/components/MarketplaceCard.tsx
@src/app/pets/marketplace/page.tsx
@src/app/friends/pets/[friendId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate LazyPetGrid into marketplace page with MarketplaceCard rendering</name>
  <files>src/app/pets/marketplace/page.tsx, src/components/MarketplaceCard.tsx</files>
  <action>
Two changes needed to wire LazyPetGrid into the marketplace:

**1. Add `petSvgNode` prop to MarketplaceCard (src/components/MarketplaceCard.tsx):**
- Add optional prop `petSvgNode?: React.ReactNode` to `MarketplaceCardProps` interface
- In the pet-display section, when `petSvgNode` is provided, render it instead of the internal AnimatedPetSVG. Keep the existing AnimatedPetSVG render as fallback when `petSvgNode` is not passed (backward compatibility for any other consumers).
- The conditional order becomes: `petSvgNode` (external SVG from LazyPetGrid) → `petId` (internal AnimatedPetSVG) → `petImage` (legacy) → placeholder text
- Import `React` (or `type { ReactNode }`) at the top if not already imported

**2. Replace direct grid in marketplace page (src/app/pets/marketplace/page.tsx):**
- Add import: `import { LazyPetGrid } from '@/components/pet-svg';` and `import type { LazyPetItem } from '@/components/pet-svg';`
- Add import: `import { loadTraits } from '@/lib/traits/migration';`
- In the listings rendering section (around line 220), replace:
  ```
  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {listings.map((listing) => (
      <MarketplaceCard ... />
    ))}
  </div>
  ```
  with LazyPetGrid using `renderCard`:
  ```tsx
  <LazyPetGrid
    pets={listings.map((listing) => ({
      id: listing.pet.id,
      traits: loadTraits(listing.pet.traits as Record<string, unknown> | null, listing.pet.id)
    }))}
    size="medium"
    columns="grid-cols-1 md:grid-cols-2 lg:grid-cols-3"
    renderCard={(pet, petSvg) => {
      const listing = listings.find(l => l.pet.id === pet.id)!;
      return (
        <MarketplaceCard
          key={listing.id}
          listingId={listing.id}
          petName={listing.pet.name}
          petId={listing.pet.id}
          petTraits={listing.pet.traits as Record<string, unknown> | null}
          petSvgNode={petSvg}
          price={listing.price}
          sellerName={listing.seller.name}
          sellerId={listing.sellerId}
          isSold={listing.status === 'sold'}
          currentUserId={currentUserId || undefined}
          userCurrency={userCurrency}
          onPurchase={handlePurchase}
          loading={purchasingId === listing.id}
        />
      );
    }}
  />
  ```
  This way, LazyPetGrid handles the IntersectionObserver culling. When a pet is off-screen, `petSvg` is the placeholder skeleton. When visible, `petSvg` is AnimatedPetSVG. MarketplaceCard receives the pre-rendered SVG via `petSvgNode` and renders it instead of creating its own AnimatedPetSVG.

  Note: The `listings.find()` lookup inside renderCard is acceptable because marketplace pages typically have 20-100 listings, making O(n) lookup negligible.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify TypeScript compilation passes
2. Run `npx vitest run --reporter=verbose` to verify no test regressions
3. Grep for `LazyPetGrid` in marketplace page: `grep -n 'LazyPetGrid' src/app/pets/marketplace/page.tsx`
4. Grep for `petSvgNode` in MarketplaceCard: `grep -n 'petSvgNode' src/components/MarketplaceCard.tsx`
  </verify>
  <done>
- MarketplaceCard accepts optional `petSvgNode` prop and renders it when provided
- Marketplace page imports and uses LazyPetGrid with renderCard prop
- Direct grid mapping (`listings.map`) replaced by LazyPetGrid
- TypeScript compiles without errors
- All existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate LazyPetGrid into friends pet view page</name>
  <files>src/app/friends/pets/[friendId]/page.tsx</files>
  <action>
Replace the direct grid mapping in the friends pet view page with LazyPetGrid:

- Add import: `import { LazyPetGrid } from '@/components/pet-svg';`
- Remove the direct `import { AnimatedPetSVG } from '@/components/pet-svg/AnimatedPetSVG';` (LazyPetGrid handles AnimatedPetSVG internally)
- Keep `import { loadTraits } from '@/lib/traits/migration';` (needed for trait conversion)

In the pets grid section (around line 223), replace:
```
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  {pets.map((pet) => (
    <div key={pet.id} className="bg-white rounded-lg shadow-lg p-6">
      <div className="mb-4 h-64 ...">
        <AnimatedPetSVG petId={pet.id} traits={loadTraits(pet.traits, pet.id)} size="medium" />
      </div>
      {/* Pet Info, Stats, Visual Traits, Personality, Actions */}
      ...
    </div>
  ))}
</div>
```

with LazyPetGrid using `renderCard`:
```tsx
<LazyPetGrid
  pets={pets.map((pet) => ({
    id: pet.id,
    traits: loadTraits(pet.traits, pet.id)
  }))}
  size="medium"
  columns="grid-cols-1 md:grid-cols-2 lg:grid-cols-3"
  renderCard={(lazyPet, petSvg) => {
    const pet = pets.find(p => p.id === lazyPet.id)!;
    return (
      <div className="bg-white rounded-lg shadow-lg p-6">
        {/* Animated Pet SVG - viewport culled */}
        <div className="mb-4 h-64 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-lg overflow-hidden flex items-center justify-center">
          {petSvg}
        </div>

        {/* Pet Info */}
        <h3 className="text-2xl font-bold text-purple-900 mb-2">{pet.name}</h3>
        <p className="text-sm text-gray-600 mb-4">Generation {pet.generation}</p>

        {/* Stats */}
        <div className="space-y-2 mb-4">
          <div className="flex justify-between items-center">
            <span className="text-sm">Health:</span>
            <span className={`text-sm font-bold ${getStatColor(pet.health)}`}>{pet.health}</span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-sm">Hunger:</span>
            <span className={`text-sm font-bold ${getStatColor(100 - pet.hunger)}`}>{pet.hunger}</span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-sm">Happiness:</span>
            <span className={`text-sm font-bold ${getStatColor(pet.happiness)}`}>{pet.happiness}</span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-sm">Energy:</span>
            <span className={`text-sm font-bold ${getStatColor(pet.energy)}`}>{pet.energy}</span>
          </div>
        </div>

        {/* Visual Traits */}
        <div className="mb-4">
          <p className="text-sm font-semibold mb-2">Visual Traits:</p>
          <div className="flex flex-wrap gap-1">
            {pet.petTraits
              .filter((pt) => pt.trait.traitType === 'visual')
              .map((pt) => (
                <span
                  key={pt.trait.id}
                  className={`px-2 py-1 rounded text-xs border ${getRarityColor(pt.trait.rarity)}`}
                >
                  {pt.trait.traitName}
                </span>
              ))}
          </div>
        </div>

        {/* Personality */}
        <div className="mb-4">
          <p className="text-sm font-semibold mb-2">Personality:</p>
          <div className="grid grid-cols-2 gap-2 text-xs">
            <div>Friendliness: {pet.friendliness}</div>
            <div>Energy: {pet.energyTrait}</div>
            <div>Curiosity: {pet.curiosity}</div>
            <div>Patience: {pet.patience}</div>
            <div>Playfulness: {pet.playfulness}</div>
          </div>
        </div>

        {/* Actions */}
        <button
          onClick={() => {
            setSelectedPet(pet);
            setShowBreedRequest(true);
          }}
          className="w-full px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700"
        >
          Request Breeding
        </button>
      </div>
    );
  }}
/>
```

This preserves all existing card content (stats, traits, personality, breeding button) while adding viewport culling for the AnimatedPetSVG via LazyPetGrid. When a friend's pet card is off-screen, the AnimatedPetSVG is replaced with a placeholder skeleton, saving GPU cycles from idle animations.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify TypeScript compilation passes
2. Run `npx vitest run --reporter=verbose` to verify no test regressions
3. Grep for `LazyPetGrid` in friends page: `grep -n 'LazyPetGrid' src/app/friends/pets/\\[friendId\\]/page.tsx`
4. Verify AnimatedPetSVG direct import removed: `grep -n 'AnimatedPetSVG' src/app/friends/pets/\\[friendId\\]/page.tsx` should return no results
  </verify>
  <done>
- Friends pet view page imports and uses LazyPetGrid with renderCard prop
- Direct AnimatedPetSVG import removed (LazyPetGrid handles it internally)
- All existing card content preserved (stats, traits, personality, breeding button)
- Direct grid mapping replaced by LazyPetGrid
- TypeScript compiles without errors
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes with zero errors
2. Unit tests: `npx vitest run` passes with zero regressions
3. Integration check: `grep -rn 'LazyPetGrid' src/app/` shows imports in both marketplace and friends pages
4. Orphan check: `grep -rn 'import.*LazyPetGrid' src/` shows LazyPetGrid imported in actual pages (no longer orphaned)
5. PERF-04 validation: Both pages that can display 20+ pets now use IntersectionObserver-based viewport culling via LazyPetGrid
</verification>

<success_criteria>
- LazyPetGrid is imported and used in src/app/pets/marketplace/page.tsx
- LazyPetGrid is imported and used in src/app/friends/pets/[friendId]/page.tsx
- MarketplaceCard accepts petSvgNode prop for viewport-culled SVG injection
- No direct `<div className="grid ...">` with `listings.map` remains in marketplace page
- No direct AnimatedPetSVG import remains in friends pet view page
- TypeScript compilation passes
- All existing tests pass with zero regressions
- PERF-04 requirement is satisfied: Views with 20+ pets activate viewport culling
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-quality/05-04-SUMMARY.md`
</output>
