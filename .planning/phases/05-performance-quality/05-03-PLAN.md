---
phase: 05-performance-quality
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/pet-svg/LazyPetGrid.tsx
  - src/components/pet-svg/index.ts
  - src/__tests__/components/lazy-pet-grid.spec.ts
autonomous: true

must_haves:
  truths:
    - "Views with 20+ pets activate viewport culling to maintain performance"
    - "Only pets near the viewport are rendered as full AnimatedPetSVG components"
    - "Placeholder skeleton maintains layout when pets are scrolled out of view"
    - "Culling activates seamlessly with 200px preload margin to prevent pop-in"
  artifacts:
    - path: "src/components/pet-svg/LazyPetGrid.tsx"
      provides: "Viewport-culled pet grid using Intersection Observer"
      exports: ["LazyPetGrid"]
      contains: "useInView"
    - path: "src/components/pet-svg/index.ts"
      provides: "Barrel export including LazyPetGrid"
      contains: "LazyPetGrid"
    - path: "src/__tests__/components/lazy-pet-grid.spec.ts"
      provides: "Tests for LazyPetGrid viewport culling behavior"
      contains: "LazyPetGrid"
  key_links:
    - from: "src/components/pet-svg/LazyPetGrid.tsx"
      to: "src/components/pet-svg/AnimatedPetSVG.tsx"
      via: "Conditional rendering based on viewport visibility"
      pattern: "inView.*AnimatedPetSVG"
    - from: "src/components/pet-svg/LazyPetGrid.tsx"
      to: "react-intersection-observer"
      via: "useInView hook for visibility detection"
      pattern: "useInView"
---

<objective>
Install react-intersection-observer, create a LazyPetGrid component that viewport-culls pet rendering for 20+ pet scenarios (PERF-04), and add tests for culling behavior.

Purpose: When a page displays 20+ pets (e.g., marketplace listings, friends' pet collections), rendering all AnimatedPetSVG components simultaneously wastes GPU/CPU resources on off-screen animations. Viewport culling renders only visible pets with a 200px preload margin to prevent scroll pop-in, replacing off-screen pets with lightweight placeholder skeletons.

Output: LazyPetGrid component, updated barrel exports, and test file verifying culling behavior.
</objective>

<execution_context>
@/Users/tarikstafford/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tarikstafford/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-performance-quality/05-RESEARCH.md
@.planning/phases/05-performance-quality/05-01-SUMMARY.md

@src/components/pet-svg/AnimatedPetSVG.tsx
@src/components/pet-svg/index.ts
@src/lib/traits/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-intersection-observer and create LazyPetGrid component</name>
  <files>
    src/components/pet-svg/LazyPetGrid.tsx
    src/components/pet-svg/index.ts
  </files>
  <action>
1. **Install react-intersection-observer:**
   ```bash
   npm install react-intersection-observer
   ```

2. **Create `src/components/pet-svg/LazyPetGrid.tsx`:**

```typescript
'use client';

import React from 'react';
import { useInView } from 'react-intersection-observer';
import type { PetTraits } from '@/lib/traits/types';
import { AnimatedPetSVG } from './AnimatedPetSVG';

export interface LazyPetItem {
  id: string;
  traits: PetTraits;
}

export interface LazyPetGridProps {
  pets: LazyPetItem[];
  size?: 'small' | 'medium' | 'large';
  columns?: string;  // Tailwind grid class override (default: responsive 1-2-3 cols)
  className?: string;
  renderCard?: (pet: LazyPetItem, petSvg: React.ReactNode) => React.ReactNode;
}
```

The component should:
- Accept an array of `LazyPetItem` objects (id + traits) and render them in a CSS grid
- Use `columns` prop for grid layout class (default: `"grid-cols-1 md:grid-cols-2 lg:grid-cols-3"`)
- For each pet, create a `LazyPetCard` inner component that uses `useInView` from react-intersection-observer
- `useInView` config: `{ threshold: 0, rootMargin: '200px', triggerOnce: false }` -- 200px preload margin, re-cull when scrolled out
- When `inView` is true: render `<AnimatedPetSVG petId={pet.id} traits={pet.traits} size={size} />`
- When `inView` is false: render a placeholder div with matching dimensions to prevent layout shift
  - Placeholder sizing based on `size` prop: small=120px, medium=240px, large=480px (matching PetSVG dimensions)
  - Placeholder classes: `"bg-gray-100 rounded-lg animate-pulse"` with width/height set via inline style
- If `renderCard` prop is provided, call it with `(pet, petSvgElement)` -- this lets consuming pages wrap the SVG in their own card layout
- If `renderCard` is not provided, render a simple card wrapper: `<div className="bg-white rounded-lg shadow-lg p-4 flex items-center justify-center">` around the SVG or placeholder

**Important implementation details:**
- The `LazyPetCard` inner component MUST receive `ref` from `useInView` and attach it to the outermost wrapper div
- Use React.memo on LazyPetCard (comparing pet.id and size for equality) since the grid may re-render frequently
- The placeholder must have the SAME outer dimensions as the rendered pet to prevent layout shift during scroll

3. **Update `src/components/pet-svg/index.ts`** to export LazyPetGrid:
   - Add: `export { LazyPetGrid } from './LazyPetGrid';`
   - Add: `export type { LazyPetGridProps, LazyPetItem } from './LazyPetGrid';`
  </action>
  <verify>
    - `npx tsc --noEmit` passes (no TypeScript errors)
    - `npm test` passes (existing tests not broken by new dependency)
    - `grep 'useInView' src/components/pet-svg/LazyPetGrid.tsx` confirms Intersection Observer usage
    - `grep 'LazyPetGrid' src/components/pet-svg/index.ts` confirms barrel export
    - `npm ls react-intersection-observer` confirms package installed
  </verify>
  <done>
    - react-intersection-observer is installed
    - LazyPetGrid component exists with viewport culling via useInView
    - 200px rootMargin preload prevents scroll pop-in
    - Placeholder skeleton maintains layout for off-screen pets
    - Barrel export includes LazyPetGrid
  </done>
</task>

<task type="auto">
  <name>Task 2: Create viewport culling tests</name>
  <files>
    src/__tests__/components/lazy-pet-grid.spec.ts
  </files>
  <action>
Create `src/__tests__/components/lazy-pet-grid.spec.ts` with the following test suite.

**File naming:** Use `.spec.ts` extension per codebase convention.

**Important:** Since jsdom does not support IntersectionObserver natively, we must mock it. react-intersection-observer provides a test utility for this.

**Setup at top of file:**
```typescript
import { vi, describe, it, expect, beforeEach } from 'vitest';

// Mock IntersectionObserver for jsdom
const mockIntersectionObserver = vi.fn();
mockIntersectionObserver.mockReturnValue({
  observe: vi.fn(),
  unobserve: vi.fn(),
  disconnect: vi.fn(),
});
window.IntersectionObserver = mockIntersectionObserver as any;
```

**Imports:**
- `{ render, screen } from '@testing-library/react'`
- `React from 'react'`
- `{ LazyPetGrid } from '@/components/pet-svg'`
- `{ generatePetTraits } from '@/lib/traits/generation'`
- `type { LazyPetItem } from '@/components/pet-svg'`

**Test 1 -- PERF-04: Component renders grid structure**
```
describe('PERF-04: LazyPetGrid viewport culling', () => {
  const generatePets = (count: number): LazyPetItem[] =>
    Array.from({ length: count }, (_, i) => ({
      id: `lazy-test-${i}`,
      traits: generatePetTraits(`lazy-test-${i}`)
    }));

  it('renders a grid container with correct number of child elements', () => {
    const pets = generatePets(25);
    const { container } = render(<LazyPetGrid pets={pets} />);

    // Grid should exist with children for each pet
    const grid = container.firstChild as HTMLElement;
    expect(grid).toBeTruthy();
    expect(grid.children.length).toBe(25);
  });

  it('creates IntersectionObserver instances for viewport tracking', () => {
    const pets = generatePets(5);
    render(<LazyPetGrid pets={pets} />);

    // IntersectionObserver should have been created (one per pet card)
    expect(mockIntersectionObserver).toHaveBeenCalled();
  });

  it('applies correct grid column classes', () => {
    const pets = generatePets(3);
    const { container } = render(
      <LazyPetGrid pets={pets} columns="grid-cols-4" />
    );

    const grid = container.firstChild as HTMLElement;
    expect(grid.className).toContain('grid-cols-4');
  });

  it('renders with custom renderCard function', () => {
    const pets = generatePets(2);
    const renderCard = (pet: LazyPetItem, svg: React.ReactNode) => (
      <div data-testid={`custom-card-${pet.id}`} key={pet.id}>
        <span>{pet.id}</span>
        {svg}
      </div>
    );

    render(<LazyPetGrid pets={pets} renderCard={renderCard} />);

    expect(screen.getByTestId('custom-card-lazy-test-0')).toBeTruthy();
    expect(screen.getByTestId('custom-card-lazy-test-1')).toBeTruthy();
  });

  it('handles empty pets array gracefully', () => {
    const { container } = render(<LazyPetGrid pets={[]} />);
    const grid = container.firstChild as HTMLElement;
    expect(grid.children.length).toBe(0);
  });

  it('renders 20+ pets without error', () => {
    // PERF-04: Must handle 20+ pets
    const pets = generatePets(30);
    const { container } = render(<LazyPetGrid pets={pets} />);

    const grid = container.firstChild as HTMLElement;
    expect(grid.children.length).toBe(30);
  });
});
```

**Note on testing approach:** Since jsdom + IntersectionObserver mocking doesn't allow simulating in/out of viewport transitions reliably, these tests validate the structural correctness of the component (grid structure, child count, custom rendering, props). The actual viewport culling behavior (inView toggling) is inherently a browser feature best validated via Playwright E2E tests or manual verification. The mock ensures the component doesn't crash when IntersectionObserver is instantiated.
  </action>
  <verify>
    - `npm test -- src/__tests__/components/lazy-pet-grid.spec.ts` passes with all tests green
    - `npm test` passes (full test suite including new tests)
  </verify>
  <done>
    - Viewport culling test file exists at src/__tests__/components/lazy-pet-grid.spec.ts
    - Contains 6 test cases: grid structure, IntersectionObserver instantiation, custom columns, custom renderCard, empty array handling, 20+ pet handling
    - PERF-04 requirement structurally validated: component handles 20+ pets with IntersectionObserver-based culling
  </done>
</task>

</tasks>

<verification>
- `npm test` passes with all tests (existing + new culling tests)
- `npx tsc --noEmit` shows no TypeScript errors
- LazyPetGrid component uses react-intersection-observer's useInView
- Barrel export includes LazyPetGrid
- Component handles 20+ pets without error
</verification>

<success_criteria>
- PERF-04: LazyPetGrid component exists and renders 20+ pets with viewport culling via IntersectionObserver
- 200px rootMargin preloads pets before they enter viewport (no pop-in)
- Placeholder skeletons maintain layout for off-screen pets
- Component exported via barrel and ready for page integration
- All tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-quality/05-03-SUMMARY.md`
</output>
