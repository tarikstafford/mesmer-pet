// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// US-001: User Registration and Authentication
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  password          String
  name              String?
  provider          String?   @default("email") // 'email', 'google', 'apple'
  providerId        String?
  isAdmin           Boolean   @default(false)  // US-027: Admin role flag

  // US-030: Data Privacy and GDPR Compliance
  dateOfBirth       DateTime?  // COPPA compliance - age verification
  cookieConsent     Boolean   @default(false)  // EU cookie consent tracking
  dataProcessingConsent Boolean @default(true) // GDPR data processing consent
  marketingConsent  Boolean   @default(false)  // Marketing communications consent
  deletionRequestedAt DateTime? // Account deletion request timestamp

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations for future user stories
  pets              Pet[]
  sessions          Session[]
  accounts          Account[]
  userSkills        UserSkill[]
  recoveryItems     UserRecoveryItem[]
  engagement        UserEngagement?
  challenges        UserChallenge[]
  sentFriendRequests     Friendship[] @relation("SentFriendRequests")
  receivedFriendRequests Friendship[] @relation("ReceivedFriendRequests")
  tutorial          UserTutorial?

  @@index([email])
}

model Account {
  id                String   @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// US-002: Pet Creation with Genetics Initialization
model Pet {
  id        String   @id @default(uuid())
  name      String
  userId    String

  // Stats (0-100 scale)
  health    Int      @default(100)
  hunger    Int      @default(0)
  happiness Int      @default(100)
  energy    Int      @default(100)

  // US-008: Pet Death Prevention and Recovery
  isCritical       Boolean  @default(false)  // True when health reaches 0
  maxHealthPenalty Int      @default(0)      // Accumulated penalty (0-100), reduces effective max health
  neglectStartedAt DateTime?                 // When pet first entered neglected state (for grace period)

  // Personality traits (0-100 scale)
  friendliness Int    @default(50)
  energyTrait  Int    @default(50) // renamed from 'energy' to avoid conflict
  curiosity    Int    @default(50)
  patience     Int    @default(50)
  playfulness  Int    @default(50)

  // Genetics and lineage
  generation   Int    @default(1)
  parent1Id    String?
  parent2Id    String?

  // Visual appearance traits (JSON) - generated by trait system
  traits       Json?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastFedAt         DateTime?
  lastInteractionAt DateTime?
  lastStatUpdate    DateTime @default(now()) // US-021: Track last stat degradation calculation
  lastBredAt        DateTime?                // US-012: Track breeding cooldown

  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  petTraits    PetTrait[]
  petSkills    PetSkill[]
  warnings     Warning[]
  interactions Interaction[]
  memorySummaries MemorySummary[]
  gameStates GameState[]

  @@index([userId])
  @@index([parent1Id])
  @@index([parent2Id])
}

// US-003: Pet Trait System
model Trait {
  id          String   @id @default(uuid())
  traitName   String   @unique
  traitType   String   // 'visual', 'personality', 'skill'
  rarity      String   // 'common', 'uncommon', 'rare', 'legendary'
  description String
  createdAt   DateTime @default(now())

  petTraits   PetTrait[]

  @@index([traitType])
  @@index([rarity])
}

model PetTrait {
  id                 String   @id @default(uuid())
  petId              String
  traitId            String
  inheritanceSource  String   // 'parent1', 'parent2', 'mutation', 'initial'
  createdAt          DateTime @default(now())

  pet                Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  trait              Trait    @relation(fields: [traitId], references: [id], onDelete: Cascade)

  @@unique([petId, traitId])
  @@index([petId])
  @@index([traitId])
}

// US-017: Skill Activation and Storage
model Skill {
  id          String   @id @default(uuid())
  skillName   String   @unique
  category    String   // 'education', 'games', 'arts', 'sports'
  description String
  price       Float    // Price in USD
  featured    Boolean  @default(false) // US-015: Featured/Popular skills
  icon        String?  // US-015: Skill icon (emoji or URL)
  active      Boolean  @default(true)  // US-027: Enable/disable skill without deletion
  createdAt   DateTime @default(now())

  userSkills  UserSkill[]
  petSkills   PetSkill[]

  @@index([category])
  @@index([featured])
  @@index([active])
}

model UserSkill {
  id           String   @id @default(uuid())
  userId       String
  skillId      String
  purchaseDate DateTime @default(now())
  active       Boolean  @default(true)

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill        Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId])
  @@index([skillId])
}

model PetSkill {
  id            String   @id @default(uuid())
  petId         String
  skillId       String
  proficiency   Int      @default(0) // 0-100
  activatedDate DateTime @default(now())

  pet           Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  skill         Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([petId, skillId])
  @@index([petId])
  @@index([skillId])
}

// US-007: Health Warning System
model Warning {
  id        String   @id @default(uuid())
  petId     String
  type      String   // 'hunger', 'health', 'critical'
  severity  String   // 'warning', 'critical'
  message   String
  cleared   Boolean  @default(false)
  createdAt DateTime @default(now())
  clearedAt DateTime?

  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([cleared])
}

// US-008: Pet Death Prevention and Recovery
model RecoveryItem {
  id          String   @id @default(uuid())
  itemName    String   @unique
  description String
  itemType    String   @default("potion") // 'potion', 'medicine', 'spell'
  price       Float    // Price in USD (0 for earnable items)
  earnable    Boolean  @default(false)  // Can be earned through gameplay
  createdAt   DateTime @default(now())

  userItems   UserRecoveryItem[]

  @@index([earnable])
}

model UserRecoveryItem {
  id           String   @id @default(uuid())
  userId       String
  itemId       String
  quantity     Int      @default(1)
  acquiredDate DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  item         RecoveryItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@index([userId])
  @@index([itemId])
}

// US-010: Hybrid Memory System
model Interaction {
  id        String   @id @default(uuid())
  petId     String
  userId    String   // Stored for quick access
  role      String   // 'user' or 'assistant'
  message   String   // The actual message content
  context   String?  // Additional context (e.g., action performed, mood)
  createdAt DateTime @default(now())

  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId, createdAt(sort: Desc)]) // Optimized for recent interactions query
  @@index([createdAt])
}

model MemorySummary {
  id          String   @id @default(uuid())
  petId       String
  summary     String   // Condensed memory (max 500 tokens)
  periodStart DateTime // Start of the period this summary covers
  periodEnd   DateTime // End of the period this summary covers
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  pet         Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([periodStart])
  @@index([periodEnd])
}

// US-019: Game Skill Implementation (Chess)
model GameState {
  id        String   @id @default(uuid())
  petId     String
  gameType  String   // 'chess', 'tic-tac-toe', etc.
  state     String   // JSON string of game state (e.g., FEN notation for chess)
  turn      String   // 'user' or 'pet'
  status    String   // 'active', 'completed', 'abandoned'
  winner    String?  // 'user', 'pet', 'draw', null
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([gameType])
  @@index([status])
}

// US-022: Daily Engagement System
model UserEngagement {
  id                String   @id @default(uuid())
  userId            String   @unique
  lastLoginDate     DateTime @default(now())
  currentStreak     Int      @default(1)
  longestStreak     Int      @default(1)
  totalLogins       Int      @default(1)
  virtualCurrency   Int      @default(0)  // Earned through daily bonuses and challenges

  // Milestone tracking
  milestone7Days    Boolean  @default(false)
  milestone30Days   Boolean  @default(false)
  milestone100Days  Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastLoginDate])
}

model DailyChallenge {
  id              String   @id @default(uuid())
  challengeName   String   @unique
  description     String
  challengeType   String   // 'feed', 'chat', 'breed', 'health_check', 'play_game'
  targetCount     Int      // Number of times action must be performed
  reward          Int      // Virtual currency reward
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())

  userChallenges  UserChallenge[]

  @@index([active])
}

model UserChallenge {
  id              String   @id @default(uuid())
  userId          String
  challengeId     String
  currentCount    Int      @default(0)
  completed       Boolean  @default(false)
  assignedDate    DateTime @default(now())
  completedDate   DateTime?

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge       DailyChallenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId, assignedDate])
  @@index([userId])
  @@index([challengeId])
  @@index([assignedDate])
  @@index([completed])
}

// US-024: Social Features - Friend System
model Friendship {
  id          String   @id @default(uuid())
  requesterId String   // User who sent the friend request
  addresseeId String   // User who received the friend request
  status      String   // 'pending', 'accepted', 'declined'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  requester   User     @relation("SentFriendRequests", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee   User     @relation("ReceivedFriendRequests", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([requesterId])
  @@index([addresseeId])
  @@index([status])
}

model BreedingRequest {
  id              String   @id @default(uuid())
  requesterId     String   // User requesting to breed
  requesterPetId  String   // Pet owned by requester
  addresseeId     String   // Friend being asked
  addresseePetId  String   // Friend's pet to breed with
  status          String   // 'pending', 'accepted', 'declined'
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([requesterId])
  @@index([addresseeId])
  @@index([status])
}

// US-025: Cross-Platform Pet Sync
model SyncState {
  id           String   @id @default(uuid())
  userId       String
  petId        String?  // null for user-level sync
  entityType   String   // 'pet', 'interaction', 'stats', 'memory'
  entityId     String   // ID of the entity being synced
  version      Int      @default(1)  // Increments on each update for conflict detection
  lastSyncedAt DateTime @default(now())
  platform     String   // 'web', 'ar', 'mobile'
  deviceId     String?  // Optional device identifier
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, entityType, entityId])
  @@index([userId])
  @@index([petId])
  @@index([entityType])
  @@index([lastSyncedAt])
}

model OfflineAction {
  id          String   @id @default(uuid())
  userId      String
  petId       String?
  actionType  String   // 'feed', 'chat', 'breed', 'recover', 'assign_skill'
  actionData  String   // JSON string of action parameters
  status      String   @default("pending") // 'pending', 'synced', 'failed', 'conflict'
  attempts    Int      @default(0)
  platform    String   // 'web', 'ar', 'mobile'
  deviceId    String?
  createdAt   DateTime @default(now())
  syncedAt    DateTime?
  error       String?  // Error message if sync failed

  @@index([userId])
  @@index([petId])
  @@index([status])
  @@index([createdAt])
}

// US-029: Onboarding Tutorial
model UserTutorial {
  id                String   @id @default(uuid())
  userId            String   @unique
  currentStep       Int      @default(0)  // 0-5: 0=not started, 1-5=steps, 6=completed
  completed         Boolean  @default(false)
  skipped           Boolean  @default(false)
  rewardGranted     Boolean  @default(false)

  // Track which steps have been completed
  stepCreatePet     Boolean  @default(false)
  stepFeed          Boolean  @default(false)
  stepChat          Boolean  @default(false)
  stepViewStats     Boolean  @default(false)
  stepLearnBreeding Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  completedAt       DateTime?

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([completed])
}

// Pet Marketplace Listings
model MarketplaceListing {
  id          String   @id @default(uuid())
  petId       String   @unique // A pet can only be listed once
  sellerId    String   // User listing the pet
  price       Int      // Price in virtual currency
  status      String   @default("active") // 'active', 'sold', 'cancelled'
  listedAt    DateTime @default(now())
  soldAt      DateTime?
  buyerId     String?  // User who purchased (if sold)

  @@index([sellerId])
  @@index([status])
  @@index([listedAt])
}
