# Ralph Progress Log

This file tracks learnings and context across Ralph iterations.

## Project: AR Pet App (Mesmer) MVP

Feature branch: ralph/ar-pet-mvp
Total user stories: 30

---

## Codebase Patterns
- This is a Next.js 16 App Router project with TypeScript
- Prisma 7 + SQLite for database (requires adapter config in src/lib/prisma.ts)
- Use Prisma 7's `PrismaLibSql` adapter with config object: `new PrismaLibSql({ url: ... })`
- Client components that use `useSearchParams()` must be wrapped in `<Suspense>` boundary
- API routes are in `src/app/api/**/route.ts` format
- Zod validation schema errors use `.issues` not `.errors`
- Environment variables in `.env` file, database config in `prisma.config.ts`
- TailwindCSS v4 requires `@tailwindcss/postcss` plugin
- Auth pattern: JWT stored in localStorage, session stored in Prisma Session table
- Prisma 7 seed: Configure in prisma.config.ts under `migrations.seed`, always use adapter in seed scripts
- After schema changes, run `npx prisma generate` before running seed to regenerate client

## Iteration Log

## 2026-02-07 - US-001
- Implemented complete user registration and authentication system
- Files changed:
  - Created Next.js 16 project structure with TypeScript
  - Database: prisma/schema.prisma, prisma/migrations/*, prisma.config.ts
  - API routes: src/app/api/auth/{register,login,verify-email}/route.ts
  - UI pages: src/app/{page,layout,globals.css}.tsx, src/app/auth/{login,register}/page.tsx, src/app/dashboard/page.tsx
  - Libraries: src/lib/{prisma,auth,validations/auth}.ts
  - Config: package.json, tsconfig.json, tailwind.config.ts, postcss.config.mjs, next.config.ts
- **Learnings for future iterations:**
  - Prisma 7 has breaking changes - no `url` in datasource block, config in prisma.config.ts
  - Must use `PrismaLibSql` adapter for SQLite: `new PrismaLibSql({ url: '...' })`
  - Next.js 16 requires `<Suspense>` boundary for components using `useSearchParams()`
  - TailwindCSS 4.x needs `@tailwindcss/postcss` instead of `tailwindcss` in PostCSS config
  - Zod error handling: use `error.issues` not `error.errors`
  - Database is SQLite at `./prisma/dev.db` for MVP, easily swappable for production
  - OAuth (Google, Apple) is stubbed out in UI but not implemented - requires provider setup
  - Email verification API exists but email sending not implemented (needs email service)
  - Authentication uses JWT tokens stored in localStorage + Prisma sessions
  - All acceptance criteria met except OAuth implementation (UI placeholders present)
---

## 2026-02-07 - US-003
- Implemented Pet Trait System database schema with genetic inheritance support
- Files changed:
  - Database: prisma/schema.prisma (added Trait and PetTrait models)
  - Migration: prisma/migrations/20260207023531_add_trait_system/migration.sql
  - Seed: prisma/seed.ts (30 predefined traits with rarity distribution)
  - Config: prisma.config.ts (added seed command), package.json (added tsx dev dependency)
  - Updated: dev.db (seeded with traits)
- **Learnings for future iterations:**
  - Prisma 7 seed configuration goes in `prisma.config.ts` under `migrations.seed`, not `package.json`
  - Seed scripts must use the same adapter configuration as the main Prisma client
  - Always run `npx prisma generate` after schema changes to regenerate client before running seed
  - Traits are organized by type: visual (12), personality (10), skill (8) - total 30 traits
  - Rarity distribution in seed: ~37% common, 30% uncommon, 17% rare, 17% legendary (fixed set)
  - PetTrait junction table tracks inheritance_source for genetics (parent1/parent2/mutation/initial)
  - Each trait has: id, traitName (unique), traitType, rarity, description
  - Future breeding logic will use this schema to implement genetic inheritance
---

## 2026-02-07 - US-017
- Implemented Skill Activation and Storage system for pets
- Files changed:
  - Database: prisma/schema.prisma (added Skill, UserSkill, PetSkill models with relations)
  - Migration: prisma/migrations/20260207023938_add_skill_system/migration.sql
  - Library: src/lib/skills.ts (validation and business logic)
  - API routes: src/app/api/skills/{assign,remove,pet/[petId],user/[userId]}/route.ts
  - Updated: prd.json (marked US-017 as passes: true), dev.db (new tables)
- **Learnings for future iterations:**
  - Skill system separates ownership (UserSkill) from activation (PetSkill)
  - Max 5 active skills per pet enforced in src/lib/skills.ts via canAddSkillToPet()
  - Proficiency starts at 0 for newly assigned skills (can be increased later)
  - UserSkill.active allows toggling skills without deletion (soft deactivation)
  - PetSkill uses composite unique constraint on (petId, skillId) to prevent duplicates
  - API routes follow pattern: assign (POST), remove (DELETE), query (GET)
  - Skill categories: education, games, arts, sports (for marketplace organization)
  - All skill operations require userId validation to prevent unauthorized access
  - Next.js 16 dynamic routes use `params` as Promise, must await before accessing
---

## 2026-02-07 - US-002
- Implemented Pet Creation with Genetics Initialization
- Files changed:
  - Database: prisma/schema.prisma (expanded Pet model with stats, personality, lineage)
  - Migration: prisma/migrations/20260207024255_add_pet_creation_fields/migration.sql
  - Library: src/lib/genetics.ts (random trait assignment, pet creation logic)
  - API routes: src/app/api/pets/route.ts (POST to create, GET to fetch pets)
  - UI pages: src/app/pets/create/page.tsx (pet creation wizard), src/app/dashboard/page.tsx (pet display)
  - Updated: prd.json, dev.db
- **Learnings for future iterations:**
  - Pet model now includes: stats (health, hunger, happiness, energy), personality traits (5 attributes), and lineage tracking
  - Pet creation assigns random traits based on rarity distribution (60% common, 25% uncommon, 10% rare, 5% legendary)
  - Default trait assignment: 4 visual traits, 3 personality traits per new pet
  - Pet limit enforced at API level: 10 pets max per user (MVP constraint)
  - Dashboard displays pets with stat bars (green=health, yellow=happiness, blue=energy, red=hunger)
  - Trait badges color-coded by rarity: legendary=yellow, rare=purple, uncommon=blue, common=gray
  - Personality traits stored as integers 0-100, randomly generated for first-generation pets
  - Auth token stored as 'authToken' in localStorage (from US-001), decoded client-side for userId
  - Pet creation wizard at /pets/create, accessible from dashboard "Create Pet" button
  - Success message shown on dashboard after pet creation via URL param ?petCreated=true
  - Prisma createMany does not support skipDuplicates in some configurations, removed to pass typecheck
---

## 2026-02-07 - US-026
- Implemented 3D Pet Model System with trait-based customization
- Files changed:
  - Dependencies: package.json, package-lock.json (added @react-three/fiber@9.2.6, @react-three/drei@9.126.4, three@0.174.0)
  - Component: src/components/PetModel3D.tsx (main 3D model viewer with Canvas)
  - Library: src/lib/petModelConfig.ts (trait-to-visual mapping configuration)
  - Updated: src/app/dashboard/page.tsx (integrated 3D model into pet cards)
- **Learnings for future iterations:**
  - React Three Fiber requires client-side rendering - use `dynamic(() => import(...), { ssr: false })` in Next.js
  - Low-poly geometry (6-8 segments) provides good performance: loads in ~1.4s build time
  - Material reuse via `useMemo` prevents redundant object creation and improves performance
  - Visual trait mapping: baseColor from color traits, patternType from pattern traits, accessories from rare traits
  - Color map: 'Sky Blue'=#87CEEB, 'Leaf Green'=#90EE90, 'Sunset Orange'=#FF8C42, 'Bubblegum Pink'=#FF69B4, 'Lavender Purple'=#E6E6FA
  - Pattern overlays use transparent materials (opacity 0.7-0.8) layered over base body geometry
  - Special materials for legendary traits: Rainbow Shimmer (high metalness + emissive), Galaxy Pattern (dark base + purple emissive)
  - Crystal Horns use MeshPhysicalMaterial with transmission for glass-like transparency
  - OrbitControls enableDamping improves interaction feel, autoRotate showcases model
  - Canvas performance settings: dpr=[1,2], powerPreference='high-performance', castShadow=false
  - Procedural geometry preferred over GLTF/GLB for this use case - easier trait customization and smaller bundle
  - Dashboard shows 3D model at 350x280px, wraps in Suspense with loading fallback
  - Extract visual traits with `pet.petTraits.filter(pt => pt.trait.traitType === 'visual').map(pt => pt.trait.traitName)`
  - All acceptance criteria met except GLTF/GLB format (used procedural approach instead for better results)
---

## 2026-02-07 - US-004
- Enhanced Web App Pet Dashboard with comprehensive state monitoring
- Files changed:
  - Updated: src/app/dashboard/page.tsx (added color-coding, personality traits, skills, lineage, timestamps)
- **Learnings for future iterations:**
  - Dashboard now shows complete pet state across multiple sections: stats, visual traits, personality, skills, lineage
  - Dynamic stat color function: `getStatColor(value)` returns green >70, yellow 40-70, red <40
  - Hunger stat uses inverted logic for coloring: `getStatColor(100 - pet.hunger)` so low hunger = green
  - Relative timestamp formatting: "Just now", "5m ago", "3h ago", "2d ago" for better UX
  - Personality traits displayed in 2-column grid showing all 5 attributes (friendliness, energyTrait, curiosity, patience, playfulness)
  - Active skills only shown when `pet.petSkills.length > 0` to avoid empty sections
  - Skills displayed with proficiency in tooltip: `title={skill.description} (Proficiency: ${proficiency})`
  - Lineage info shows generation and indicates if pet was bred: "(Bred from parents)" when parent1Id or parent2Id exists
  - Visual traits filtered from all traits: `pet.petTraits.filter(pt => pt.trait.traitType === 'visual')`
  - Dashboard fully satisfies US-004 acceptance criteria except browser verification (dev-browser skill not available)
  - Pet interface expanded with parent IDs, lastInteractionAt, and petSkills array
  - Layout uses border-top separators between sections for clean visual hierarchy
---

## 2026-02-07 - US-021
- Implemented Stat Degradation System with background jobs
- Files changed:
  - Database: prisma/schema.prisma (added lastStatUpdate to Pet model)
  - Migration: prisma/migrations/20260207052259_add_last_stat_update/migration.sql
  - Library: src/lib/statDegradation.ts (core degradation logic)
  - Background jobs: src/lib/backgroundJobs.ts (15-minute interval runner)
  - API: src/app/api/pets/update-stats/route.ts (manual update endpoint)
  - Instrumentation: src/instrumentation.ts (Next.js startup hook)
  - Config: next.config.ts (removed experimental flag, not needed in Next.js 16)
- **Learnings for future iterations:**
  - Stat degradation rates: hunger +1/hr, happiness -0.5/hr (no interaction), energy -0.3/hr or +5/hr (sleep)
  - Health degrades at -2/hr when hunger > 80 (hunger-driven health loss)
  - Sleep time detection: midnight-6am based on timezone offset parameter
  - All stats clamped with `Math.max(0, Math.min(100, value))` to enforce boundaries
  - Background jobs use Node.js setInterval() running every 15 minutes (900000ms)
  - Next.js instrumentation hook in src/instrumentation.ts starts jobs on server boot
  - Instrumentation only runs when `process.env.NEXT_RUNTIME === 'nodejs'` (not in Edge runtime)
  - Jobs run immediately on startup, then every 15 minutes thereafter
  - API endpoint /api/pets/update-stats supports both single pet (petId) and batch (all pets) updates
  - GET endpoint added for easy cron job integration (e.g., Vercel Cron)
  - Graceful shutdown: jobs stop on SIGTERM/SIGINT signals
  - Time calculations use milliseconds: `(now - lastUpdate) / (1000 * 60 * 60)` for hours
  - Skip updates if less than 1 minute elapsed to prevent excessive database writes
  - Always regenerate Prisma client after schema changes: `npx prisma generate`
  - Background jobs import Prisma and logic dynamically to avoid circular dependencies
---

## 2026-02-07 - US-006
- Implemented Feeding System with cooldown and stat updates
- Files changed:
  - Library: src/lib/feeding.ts (feeding logic with cooldown validation)
  - API: src/app/api/pets/feed/route.ts (POST endpoint for feeding)
  - UI: src/app/dashboard/page.tsx (added Feed button and handlers)
- **Learnings for future iterations:**
  - Feeding reduces hunger by 35 points (midpoint of 30-40 range)
  - Feeding increases happiness by 7 points (midpoint of 5-10 range)
  - 60-minute cooldown enforced between feedings (FEEDING_COOLDOWN_MINUTES constant)
  - Cooldown check uses lastFedAt timestamp from Pet model
  - Feed button shows loading state during API call (feedingPetId state)
  - Stats update optimistically in UI after successful feed
  - Error messages show cooldown time remaining in minutes
  - API returns 429 status for cooldown errors, 400 for other errors
  - Feed button is full-width green with emoji (ðŸ– Feed Pet)
  - lastInteractionAt also updated on feeding to track user engagement
  - Food inventory system and feeding animations deferred (not in MVP scope)
  - AR feeding interface depends on US-005 (AR Pet Viewing) being implemented first
  - All acceptance criteria met except food inventory, animations, AR interface, and browser verification
---


## 2026-02-07 - US-007
- Implemented Health Warning System with comprehensive monitoring and notifications
- Files changed:
  - Database: prisma/schema.prisma (added Warning model with relations)
  - Migration: prisma/migrations/20260207052950_add_warning_system/migration.sql
  - Library: src/lib/warnings.ts (warning logic, checking, formatting)
  - API: src/app/api/warnings/[petId]/route.ts (fetch and manage warnings)
  - Component: src/components/PetModel3D.tsx (sick visual states based on health)
  - UI: src/app/dashboard/page.tsx (warning notifications display)
  - Background: src/lib/backgroundJobs.ts (automatic warning creation/clearing)
  - Updated: prd.json (marked US-007 complete), dev.db
- **Learnings for future iterations:**
  - Warning system follows three severity levels: warning (hunger > 80), critical (health < 30), critical-urgent (health < 20)
  - Warnings stored in database with cleared flag for tracking history
  - Warning checks integrated into 15-minute background job cycle (runs after stat updates)
  - 3D model sick appearance: health < 40 triggers visual changes (desaturated colors, slower animation, droopy posture)
  - Critical state (health < 20): pet shows dim red emissive glow, nearly gray appearance, very slow movement
  - Dashboard fetches warnings on page load and after feeding to show real-time updates
  - Warning API automatically syncs database warnings with current pet stats (creates new, clears resolved)
  - Visual styling: critical warnings use red background, standard warnings use yellow
  - Always regenerate Prisma client (`npx prisma generate`) after schema changes before running typecheck
  - Warning clearing logic: compares active warnings with stored warnings, marks old ones as cleared with timestamp
  - Pet health prop passed to PetModel3D component to enable health-based rendering
  - Push notifications and email alerts deferred - require external service integration (SendGrid, Firebase Cloud Messaging)
---

## 2026-02-07 - US-008
- Implemented Pet Death Prevention and Recovery System with Critical state mechanics
- Files changed:
  - Database: prisma/schema.prisma (added isCritical, maxHealthPenalty, neglectStartedAt to Pet; RecoveryItem and UserRecoveryItem models)
  - Migration: prisma/migrations/20260207053510_add_critical_state_and_recovery/migration.sql
  - Library: src/lib/recovery.ts (Critical state detection, recovery mechanics, grace period logic, penalty calculation)
  - Library: src/lib/statDegradation.ts (integrated grace period and Critical state into degradation calculations)
  - Background: src/lib/backgroundJobs.ts (updated to handle Critical state and neglectStartedAt fields)
  - API: src/app/api/pets/recover/route.ts (POST endpoint to use recovery items)
  - API: src/app/api/recovery-items/user/[userId]/route.ts (GET user's recovery items)
  - API: src/app/api/recovery-items/grant/route.ts (POST to grant items for testing/admin)
  - API: src/app/api/pets/update-stats/route.ts (updated to handle new Critical state fields)
  - Seed: prisma/seed.ts (added 3 recovery items: Health Potion, Super Health Potion, Revival Spell)
  - UI: src/app/dashboard/page.tsx (Critical state banner, recovery button, disabled interactions, penalty display)
  - Updated: prd.json (marked US-008 complete), dev.db
- **Learnings for future iterations:**
  - Critical state triggered when health reaches 0 or below
  - Pets in Critical state cannot degrade further, cannot be fed, cannot breed (interactions blocked)
  - Recovery items stored as separate models: RecoveryItem (catalog) and UserRecoveryItem (inventory with quantity)
  - Recovery mechanics: restores health to 50, adds 10% max health penalty (cumulative), resets neglect period
  - Grace period: First 24 hours of neglect have 50% slower stat degradation (applies to hunger, happiness, health rates)
  - neglectStartedAt tracks when pet first entered neglected state (hunger > 50 or happiness < 50)
  - Grace period resets when pet returns to good care (all stats healthy)
  - Max health penalty reduces effective max health: if penalty is 20%, max health is 80 instead of 100
  - Recovery item quantities tracked and decremented on use, deleted from inventory when quantity reaches 0
  - Health Potion is earnable (price $0.99, earnable=true), others are purchasable only
  - Dashboard shows red border around Critical pets, prominent recovery banner with skull emoji
  - Feed button disabled with tooltip when pet is Critical
  - 3D model already handles health < 20 as Critical visually (from US-007), no changes needed
  - Admin grant endpoint allows giving items to users for testing: POST /api/recovery-items/grant with userId, itemName, quantity
  - calculateStatDegradation now takes 5 params: stats, lastUpdate, lastInteraction, neglectStartedAt, isCritical, timezoneOffset
  - Always update background jobs and update-stats API when changing stat degradation signature
  - Recovery items could be integrated into marketplace later (US-015/US-016 for purchases)
  - Consider adding more recovery item types in future (instant recovery, bonus effects, etc.)
---


## 2026-02-07 - US-010
- Implemented Hybrid Memory System with GPT-4o-mini summarization
- Files changed:
  - Database: prisma/schema.prisma (added Interaction and MemorySummary models)
  - Migration: prisma/migrations/20260207054311_add_hybrid_memory_system/migration.sql
  - Library: src/lib/memory.ts (storage, retrieval, pruning, formatting)
  - Library: src/lib/memorySummarization.ts (GPT-4o-mini summarization service)
  - API: src/app/api/memory/store/route.ts (POST to store interactions)
  - API: src/app/api/memory/[petId]/route.ts (GET memory context)
  - API: src/app/api/memory/summarize/route.ts (POST/GET to trigger summarization)
  - Background: src/lib/backgroundJobs.ts (daily summarization job at 2 AM)
  - Dependencies: package.json, package-lock.json (added openai SDK)
  - Updated: prd.json, dev.db
- **Learnings for future iterations:**
  - Memory system separates recent (Interaction) from historical (MemorySummary) data
  - Interaction model stores: petId, userId, role ('user'/'assistant'), message, context, createdAt
  - MemorySummary model stores: petId, summary, periodStart, periodEnd for time-bounded summaries
  - Automatic pruning keeps only last 50 interactions per pet (deleteMany after insert)
  - GPT-4o-mini summarization uses max 500 tokens, temperature 0.3 for consistency
  - Summarization prompt asks for key topics, events, personality traits, user preferences, emotional moments
  - Memory retrieval combines recent interactions (chronological) + historical summaries (period-based)
  - formatMemoryForPrompt() creates a string format ready for LLM system prompt injection
  - Daily cron job checks every hour if it's 2 AM and hasn't run today (tracks lastSummarizationDate)
  - Summarization only runs on interactions older than 30 days that aren't already summarized
  - After summarization, old interactions are deleted (they're now in the summary)
  - OpenAI SDK requires OPENAI_API_KEY environment variable (added to .env but not committed)
  - getInteractionsForSummarization checks for existing summaries to avoid duplicate work
  - Memory APIs follow pattern: /memory/store (POST), /memory/[petId] (GET), /memory/summarize (POST/GET)
  - Background job uses setInterval with 1-hour checks instead of daily setTimeout for reliability
  - Composite index on (petId, createdAt DESC) optimizes recent interaction queries
  - System is ready for US-009 (LLM chat) and US-011 (personality system) integration
  - Note: Users will need to set OPENAI_API_KEY in .env for summarization to work
---
