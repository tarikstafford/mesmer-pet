# Ralph Progress Log

This file tracks learnings and context across Ralph iterations.

## Project: AR Pet App (Mesmer) MVP

Feature branch: ralph/ar-pet-mvp
Total user stories: 30

---

## Codebase Patterns
- This is a Next.js 16 App Router project with TypeScript
- Prisma 7 + SQLite for database (requires adapter config in src/lib/prisma.ts)
- Use Prisma 7's `PrismaLibSql` adapter with config object: `new PrismaLibSql({ url: ... })`
- Client components that use `useSearchParams()` must be wrapped in `<Suspense>` boundary
- API routes are in `src/app/api/**/route.ts` format
- Zod validation schema errors use `.issues` not `.errors`
- Environment variables in `.env` file, database config in `prisma.config.ts`
- TailwindCSS v4 requires `@tailwindcss/postcss` plugin
- Auth pattern: JWT stored in localStorage, session stored in Prisma Session table
- Prisma 7 seed: Configure in prisma.config.ts under `migrations.seed`, always use adapter in seed scripts
- After schema changes, run `npx prisma generate` before running seed to regenerate client

## Iteration Log

## 2026-02-07 - US-001
- Implemented complete user registration and authentication system
- Files changed:
  - Created Next.js 16 project structure with TypeScript
  - Database: prisma/schema.prisma, prisma/migrations/*, prisma.config.ts
  - API routes: src/app/api/auth/{register,login,verify-email}/route.ts
  - UI pages: src/app/{page,layout,globals.css}.tsx, src/app/auth/{login,register}/page.tsx, src/app/dashboard/page.tsx
  - Libraries: src/lib/{prisma,auth,validations/auth}.ts
  - Config: package.json, tsconfig.json, tailwind.config.ts, postcss.config.mjs, next.config.ts
- **Learnings for future iterations:**
  - Prisma 7 has breaking changes - no `url` in datasource block, config in prisma.config.ts
  - Must use `PrismaLibSql` adapter for SQLite: `new PrismaLibSql({ url: '...' })`
  - Next.js 16 requires `<Suspense>` boundary for components using `useSearchParams()`
  - TailwindCSS 4.x needs `@tailwindcss/postcss` instead of `tailwindcss` in PostCSS config
  - Zod error handling: use `error.issues` not `error.errors`
  - Database is SQLite at `./prisma/dev.db` for MVP, easily swappable for production
  - OAuth (Google, Apple) is stubbed out in UI but not implemented - requires provider setup
  - Email verification API exists but email sending not implemented (needs email service)
  - Authentication uses JWT tokens stored in localStorage + Prisma sessions
  - All acceptance criteria met except OAuth implementation (UI placeholders present)
---

## 2026-02-07 - US-003
- Implemented Pet Trait System database schema with genetic inheritance support
- Files changed:
  - Database: prisma/schema.prisma (added Trait and PetTrait models)
  - Migration: prisma/migrations/20260207023531_add_trait_system/migration.sql
  - Seed: prisma/seed.ts (30 predefined traits with rarity distribution)
  - Config: prisma.config.ts (added seed command), package.json (added tsx dev dependency)
  - Updated: dev.db (seeded with traits)
- **Learnings for future iterations:**
  - Prisma 7 seed configuration goes in `prisma.config.ts` under `migrations.seed`, not `package.json`
  - Seed scripts must use the same adapter configuration as the main Prisma client
  - Always run `npx prisma generate` after schema changes to regenerate client before running seed
  - Traits are organized by type: visual (12), personality (10), skill (8) - total 30 traits
  - Rarity distribution in seed: ~37% common, 30% uncommon, 17% rare, 17% legendary (fixed set)
  - PetTrait junction table tracks inheritance_source for genetics (parent1/parent2/mutation/initial)
  - Each trait has: id, traitName (unique), traitType, rarity, description
  - Future breeding logic will use this schema to implement genetic inheritance
---

## 2026-02-07 - US-017
- Implemented Skill Activation and Storage system for pets
- Files changed:
  - Database: prisma/schema.prisma (added Skill, UserSkill, PetSkill models with relations)
  - Migration: prisma/migrations/20260207023938_add_skill_system/migration.sql
  - Library: src/lib/skills.ts (validation and business logic)
  - API routes: src/app/api/skills/{assign,remove,pet/[petId],user/[userId]}/route.ts
  - Updated: prd.json (marked US-017 as passes: true), dev.db (new tables)
- **Learnings for future iterations:**
  - Skill system separates ownership (UserSkill) from activation (PetSkill)
  - Max 5 active skills per pet enforced in src/lib/skills.ts via canAddSkillToPet()
  - Proficiency starts at 0 for newly assigned skills (can be increased later)
  - UserSkill.active allows toggling skills without deletion (soft deactivation)
  - PetSkill uses composite unique constraint on (petId, skillId) to prevent duplicates
  - API routes follow pattern: assign (POST), remove (DELETE), query (GET)
  - Skill categories: education, games, arts, sports (for marketplace organization)
  - All skill operations require userId validation to prevent unauthorized access
  - Next.js 16 dynamic routes use `params` as Promise, must await before accessing
---

